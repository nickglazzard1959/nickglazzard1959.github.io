!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("babylonjs")):"function"==typeof define&&define.amd?define("babylonjs-serializers",["babylonjs"],t):"object"==typeof exports?exports["babylonjs-serializers"]=t(require("babylonjs")):e.SERIALIZERS=t(e.BABYLON)}("undefined"!=typeof self?self:"undefined"!=typeof global?global:this,(e=>(()=>{"use strict";var t={597:t=>{t.exports=e}},r={};function n(e){var i=r[e];if(void 0!==i)return i.exports;var a=r[e]={exports:{}};return t[e](a,a.exports,n),a.exports}n.d=(e,t)=>{for(var r in t)n.o(t,r)&&!n.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:t[r]})},n.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var i={};return(()=>{n.d(i,{default:()=>ae});var e={};n.r(e),n.d(e,{__IGLTFExporterExtension:()=>u});var t={};n.r(t),n.d(t,{GLTFData:()=>l});var r={};n.r(r),n.d(r,{GLTF2Export:()=>A});var a={};n.r(a),n.d(a,{EXT_mesh_gpu_instancing:()=>Y,KHR_lights_punctual:()=>w,KHR_materials_anisotropy:()=>B,KHR_materials_clearcoat:()=>R,KHR_materials_diffuse_transmission:()=>$,KHR_materials_dispersion:()=>q,KHR_materials_emissive_strength:()=>Z,KHR_materials_ior:()=>k,KHR_materials_iridescence:()=>S,KHR_materials_sheen:()=>N,KHR_materials_specular:()=>D,KHR_materials_transmission:()=>j,KHR_materials_unlit:()=>L,KHR_materials_volume:()=>W,KHR_texture_transform:()=>M});var o={};n.r(o),n.d(o,{EXT_mesh_gpu_instancing:()=>Y,GLTF2Export:()=>A,GLTFData:()=>l,KHR_lights_punctual:()=>w,KHR_materials_anisotropy:()=>B,KHR_materials_clearcoat:()=>R,KHR_materials_diffuse_transmission:()=>$,KHR_materials_dispersion:()=>q,KHR_materials_emissive_strength:()=>Z,KHR_materials_ior:()=>k,KHR_materials_iridescence:()=>S,KHR_materials_sheen:()=>N,KHR_materials_specular:()=>D,KHR_materials_transmission:()=>j,KHR_materials_unlit:()=>L,KHR_materials_volume:()=>W,KHR_texture_transform:()=>M,_BinaryWriter:()=>b,_Exporter:()=>v,_GLTFAnimation:()=>g,_GLTFMaterialExporter:()=>_,_GLTFUtilities:()=>m,__IGLTFExporterExtensionV2:()=>ee});var s={};n.r(s),n.d(s,{EXT_mesh_gpu_instancing:()=>Y,GLTF2Export:()=>A,GLTFData:()=>l,KHR_lights_punctual:()=>w,KHR_materials_anisotropy:()=>B,KHR_materials_clearcoat:()=>R,KHR_materials_diffuse_transmission:()=>$,KHR_materials_dispersion:()=>q,KHR_materials_emissive_strength:()=>Z,KHR_materials_ior:()=>k,KHR_materials_iridescence:()=>S,KHR_materials_sheen:()=>N,KHR_materials_specular:()=>D,KHR_materials_transmission:()=>j,KHR_materials_unlit:()=>L,KHR_materials_volume:()=>W,KHR_texture_transform:()=>M,_BinaryWriter:()=>b,_Exporter:()=>v,_GLTFAnimation:()=>g,_GLTFMaterialExporter:()=>_,_GLTFUtilities:()=>m,__IGLTFExporterExtension:()=>u,__IGLTFExporterExtensionV2:()=>ee});var u=0,l=function(){function e(){this.glTFFiles={}}return e.prototype.downloadFiles=function(){function e(e,t){return-1!==e.indexOf(t,e.length-t.length)}for(var t in this.glTFFiles){var r=document.createElement("a");document.body.appendChild(r),r.setAttribute("type","hidden"),r.download=t;var n=this.glTFFiles[t],i=void 0;e(t,".glb")?i={type:"model/gltf-binary"}:e(t,".bin")?i={type:"application/octet-stream"}:e(t,".gltf")?i={type:"model/gltf+json"}:e(t,".jpeg")||e(t,".jpg")?i={type:"image/jpeg"}:e(t,".png")&&(i={type:"image/png"}),r.href=window.URL.createObjectURL(new Blob([n],i)),r.click()}},e}();function c(e,t,r,n){return new(r||(r=Promise))((function(i,a){function o(e){try{u(n.next(e))}catch(e){a(e)}}function s(e){try{u(n.throw(e))}catch(e){a(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(o,s)}u((n=n.apply(e,t||[])).next())}))}function f(e,t){var r,n,i,a,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return a={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(u){return function(s){if(r)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(o=0)),o;)try{if(r=1,n&&(i=2&s[0]?n.return:s[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,s[1])).done)return i;switch(n=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return o.label++,{value:s[1],done:!1};case 5:o.label++,n=s[1],s=[0];continue;case 7:s=o.ops.pop(),o.trys.pop();continue;default:if(!((i=(i=o.trys).length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){o=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){o.label=s[1];break}if(6===s[0]&&o.label<i[1]){o.label=i[1],i=s;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(s);break}i[2]&&o.ops.pop(),o.trys.pop();continue}s=t.call(e,o)}catch(e){s=[6,e],n=0}finally{r=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function h(e,t,r){if(r||2===arguments.length)for(var n,i=0,a=t.length;i<a;i++)!n&&i in t||(n||(n=Array.prototype.slice.call(t,0,i)),n[i]=t[i]);return e.concat(n||Array.prototype.slice.call(t))}Object.create,Object.create,"function"==typeof SuppressedError&&SuppressedError;var p,d=n(597),_=function(){function e(e){this._textureMap={},this._internalTextureToImage={},this._textureMap={},this._exporter=e}return e._FuzzyEquals=function(e,t,r){return d.Scalar.WithinEpsilon(e.r,t.r,r)&&d.Scalar.WithinEpsilon(e.g,t.g,r)&&d.Scalar.WithinEpsilon(e.b,t.b,r)},e.prototype._convertMaterialsToGLTFAsync=function(e,t,r){var n=this,i=[];return e.forEach((function(e){"StandardMaterial"===e.getClassName()?i.push(n._convertStandardMaterialAsync(e,t,r)):-1!==e.getClassName().indexOf("PBR")?i.push(n._convertPBRMaterialAsync(e,t,r)):d.Tools.Warn("Unsupported material type: ".concat(e.name))})),Promise.all(i).then((function(){}))},e.prototype._stripTexturesFromMaterial=function(e){var t={};if(e){t.name=e.name,t.doubleSided=e.doubleSided,t.alphaMode=e.alphaMode,t.alphaCutoff=e.alphaCutoff,t.emissiveFactor=e.emissiveFactor;var r=e.pbrMetallicRoughness;r&&(t.pbrMetallicRoughness={},t.pbrMetallicRoughness.baseColorFactor=r.baseColorFactor,t.pbrMetallicRoughness.metallicFactor=r.metallicFactor,t.pbrMetallicRoughness.roughnessFactor=r.roughnessFactor)}return t},e.prototype._hasTexturesPresent=function(e){var t;if(e.emissiveTexture||e.normalTexture||e.occlusionTexture)return!0;var r=e.pbrMetallicRoughness;if(r&&(r.baseColorTexture||r.metallicRoughnessTexture))return!0;if(e.extensions)for(var n in e.extensions){var i=e.extensions[n];if(i)return null===(t=i.hasTextures)||void 0===t?void 0:t.call(i)}return!1},e.prototype._getTextureInfo=function(e){if(e){var t=e.uid;if(t in this._textureMap)return this._textureMap[t]}return null},e.prototype._convertToGLTFPBRMetallicRoughness=function(t){var r,n,i,a,o,s,u=new d.Vector2(0,1),l=new d.Vector2(0,.1),c=new d.Vector2(0,.1),f=new d.Vector2(1300,.1),h=t.diffuseColor.toLinearSpace(t.getScene().getEngine().useExactSrgbConversions).scale(.5),p=t.alpha,_=(r=d.Scalar.Clamp(t.specularPower,0,e._MaxSpecularPower),n=Math.pow(r/f.x,.333333),i=u.y,a=l.y,o=c.y,s=f.y,(1-n)*(1-n)*(1-n)*i+3*(1-n)*(1-n)*n*a+3*(1-n)*n*n*o+n*n*n*s);return{baseColorFactor:[h.r,h.g,h.b,p],metallicFactor:0,roughnessFactor:_}},e._SolveMetallic=function(e,t,r){if(t<this._DielectricSpecular.r)return this._DielectricSpecular,0;var n=this._DielectricSpecular.r,i=e*r/(1-this._DielectricSpecular.r)+t-2*this._DielectricSpecular.r,a=i*i-4*n*(this._DielectricSpecular.r-t);return d.Scalar.Clamp((-i+Math.sqrt(a))/(2*n),0,1)},e._SetAlphaMode=function(e,t){t.needAlphaBlending()?e.alphaMode="BLEND":t.needAlphaTesting()&&(e.alphaMode="MASK",e.alphaCutoff=t.alphaCutOff)},e.prototype._convertStandardMaterialAsync=function(t,r,n){var i=this._exporter._materialMap,a=this._exporter._materials,o=[],s=this._convertToGLTFPBRMetallicRoughness(t),u={name:t.name};if(null==t.backFaceCulling||t.backFaceCulling||(t.twoSidedLighting||d.Tools.Warn(t.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),u.doubleSided=!0),n){t.diffuseTexture&&o.push(this._exportTextureAsync(t.diffuseTexture,r).then((function(e){e&&(s.baseColorTexture=e)})));var l=t.bumpTexture;l&&o.push(this._exportTextureAsync(l,r).then((function(e){e&&(u.normalTexture=e,1!==l.level&&(u.normalTexture.scale=l.level))}))),t.emissiveTexture&&(u.emissiveFactor=[1,1,1],o.push(this._exportTextureAsync(t.emissiveTexture,r).then((function(e){e&&(u.emissiveTexture=e)})))),t.ambientTexture&&o.push(this._exportTextureAsync(t.ambientTexture,r).then((function(e){if(e){var t={index:e.index};u.occlusionTexture=t}})))}return(t.alpha<1||t.opacityTexture)&&(t.alphaMode===d.Constants.ALPHA_COMBINE?u.alphaMode="BLEND":d.Tools.Warn(t.name+": glTF 2.0 does not support alpha mode: "+t.alphaMode.toString())),t.emissiveColor&&!e._FuzzyEquals(t.emissiveColor,d.Color3.Black(),e._Epsilon)&&(u.emissiveFactor=t.emissiveColor.asArray()),u.pbrMetallicRoughness=s,e._SetAlphaMode(u,t),a.push(u),i[t.uniqueId]=a.length-1,this._finishMaterial(o,u,t,r)},e.prototype._finishMaterial=function(e,t,r,n){var i=this;return Promise.all(e).then((function(){for(var e=null,a=0,o=i._exporter._extensionsPostExportMaterialAdditionalTextures("exportMaterial",t,r);a<o.length;a++){var s=o[a];e||(e=[]),e.push(i._exportTextureAsync(s,n))}return e||(e=[Promise.resolve(null)]),Promise.all(e).then((function(){var e=i._exporter._extensionsPostExportMaterialAsync("exportMaterial",t,r);return e?e.then((function(){return t})):t}))}))},e.prototype._getImageDataAsync=function(e,t,r,n){return c(this,void 0,void 0,(function(){var i,a,o,s,u;return f(this,(function(l){switch(l.label){case 0:return i=d.Constants.TEXTURETYPE_UNSIGNED_INT,a=this._exporter._babylonScene,o=a.getEngine(),s=o.createRawTexture(e,t,r,d.Constants.TEXTUREFORMAT_RGBA,!1,!0,d.Texture.NEAREST_SAMPLINGMODE,null,i),[4,d.TextureTools.ApplyPostProcess("pass",s,a,i,d.Constants.TEXTURE_NEAREST_SAMPLINGMODE,d.Constants.TEXTUREFORMAT_RGBA)];case 1:return l.sent(),[4,o._readTexturePixels(s,t,r)];case 2:return u=l.sent(),[4,d.DumpTools.DumpDataAsync(t,r,u,n,void 0,!0,!0)];case 3:return[2,l.sent()]}}))}))},e.prototype._createWhiteTexture=function(e,t,r){for(var n=new Uint8Array(e*t*4),i=0;i<n.length;i+=4)n[i]=n[i+1]=n[i+2]=n[i+3]=255;return d.RawTexture.CreateRGBATexture(n,e,t,r)},e.prototype._resizeTexturesToSameDimensions=function(e,t,r){var n,i,a=e?e.getSize():{width:0,height:0},o=t?t.getSize():{width:0,height:0};return a.width<o.width?(n=e&&e instanceof d.Texture?d.TextureTools.CreateResizedCopy(e,o.width,o.height,!0):this._createWhiteTexture(o.width,o.height,r),i=t):a.width>o.width?(i=t&&t instanceof d.Texture?d.TextureTools.CreateResizedCopy(t,a.width,a.height,!0):this._createWhiteTexture(a.width,a.height,r),n=e):(n=e,i=t),{texture1:n,texture2:i}},e.prototype._convertPixelArrayToFloat32=function(e){if(e instanceof Uint8Array){for(var t=e.length,r=new Float32Array(e.length),n=0;n<t;++n)r[n]=e[n]/255;return r}if(e instanceof Float32Array)return e;throw new Error("Unsupported pixel format!")},e.prototype._convertSpecularGlossinessTexturesToMetallicRoughnessAsync=function(t,r,n,i){var a;return c(this,void 0,void 0,(function(){var o,s,u,l,c,h,p,_,m,g,x,y,T,v,b,A,E,M,F,w,C,R,V,S,I,B,P,N,O,L,U;return f(this,(function(f){switch(f.label){case 0:return o=new Array,t||r?(s=t?t.getScene():r?r.getScene():null)?(u=this._resizeTexturesToSameDimensions(t,r,s),l=null===(a=u.texture1)||void 0===a?void 0:a.getSize(),c=void 0,h=void 0,p=l.width,_=l.height,[4,u.texture1.readPixels()]):[3,3]:[2,Promise.reject("_ConvertSpecularGlosinessTexturesToMetallicRoughness: diffuse and specular glossiness textures are not defined!")];case 1:return m=f.sent(),[4,u.texture2.readPixels()];case 2:if(g=f.sent(),!m)return[2,Promise.reject("Failed to retrieve pixels from diffuse texture!")];if(c=this._convertPixelArrayToFloat32(m),!g)return[2,Promise.reject("Failed to retrieve pixels from specular glossiness texture!")];for(h=this._convertPixelArrayToFloat32(g),x=h.byteLength,y=new Uint8Array(x),T=new Uint8Array(x),v=d.Color3.Black(),b=0,A=0,B=0;B<_;++B)for(P=0;P<p;++P)E=4*(p*B+P),M=new d.Color3(c[E],c[E+1],c[E+2]).toLinearSpace(s.getEngine().useExactSrgbConversions).multiply(n.diffuseColor),F=new d.Color3(h[E],h[E+1],h[E+2]).toLinearSpace(s.getEngine().useExactSrgbConversions).multiply(n.specularColor),w=h[E+3]*n.glossiness,C={diffuseColor:M,specularColor:F,glossiness:w},R=this._convertSpecularGlossinessToMetallicRoughness(C),v.r=Math.max(v.r,R.baseColor.r),v.g=Math.max(v.g,R.baseColor.g),v.b=Math.max(v.b,R.baseColor.b),b=Math.max(b,R.metallic),A=Math.max(A,R.roughness),T[E]=255*R.baseColor.r,T[E+1]=255*R.baseColor.g,T[E+2]=255*R.baseColor.b,T[E+3]=u.texture1.hasAlpha?255*c[E+3]:255,y[E]=0,y[E+1]=255*R.roughness,y[E+2]=255*R.metallic,y[E+3]=255;for(V={baseColor:v,metallic:b,roughness:A},S=!1,I=!1,B=0;B<_;++B)for(P=0;P<p;++P)T[N=4*(p*B+P)]/=V.baseColor.r>e._Epsilon?V.baseColor.r:1,T[N+1]/=V.baseColor.g>e._Epsilon?V.baseColor.g:1,T[N+2]/=V.baseColor.b>e._Epsilon?V.baseColor.b:1,O=d.Color3.FromInts(T[N],T[N+1],T[N+2]),L=O.toGammaSpace(s.getEngine().useExactSrgbConversions),T[N]=255*L.r,T[N+1]=255*L.g,T[N+2]=255*L.b,e._FuzzyEquals(L,d.Color3.White(),e._Epsilon)||(I=!0),y[N+1]/=V.roughness>e._Epsilon?V.roughness:1,y[N+2]/=V.metallic>e._Epsilon?V.metallic:1,U=d.Color3.FromInts(255,y[N+1],y[N+2]),e._FuzzyEquals(U,d.Color3.White(),e._Epsilon)||(S=!0);return S&&o.push(this._getImageDataAsync(y,p,_,i).then((function(e){V.metallicRoughnessTextureData=e}))),I&&o.push(this._getImageDataAsync(T,p,_,i).then((function(e){V.baseColorTextureData=e}))),[2,Promise.all(o).then((function(){return V}))];case 3:return[2,Promise.reject("_ConvertSpecularGlossinessTexturesToMetallicRoughness: Scene from textures is missing!")]}}))}))},e.prototype._convertSpecularGlossinessToMetallicRoughness=function(t){var r=this._getPerceivedBrightness(t.diffuseColor),n=this._getPerceivedBrightness(t.specularColor),i=1-this._getMaxComponent(t.specularColor),a=e._SolveMetallic(r,n,i),o=t.diffuseColor.scale(i/(1-e._DielectricSpecular.r)/Math.max(1-a,e._Epsilon)),s=t.specularColor.subtract(e._DielectricSpecular.scale(1-a)).scale(1/Math.max(a,e._Epsilon)),u=d.Color3.Lerp(o,s,a*a);return{baseColor:u=u.clampToRef(0,1,u),metallic:a,roughness:1-t.glossiness}},e.prototype._getPerceivedBrightness=function(e){return e?Math.sqrt(.299*e.r*e.r+.587*e.g*e.g+.114*e.b*e.b):0},e.prototype._getMaxComponent=function(e){return e?Math.max(e.r,Math.max(e.g,e.b)):0},e.prototype._convertMetalRoughFactorsToMetallicRoughnessAsync=function(e,t,r,n){var i=[],a={baseColor:e._albedoColor,metallic:e._metallic,roughness:e._roughness};if(n){e._albedoTexture&&i.push(this._exportTextureAsync(e._albedoTexture,t).then((function(e){e&&(r.baseColorTexture=e)})));var o=e._metallicTexture;o&&i.push(this._exportTextureAsync(o,t).then((function(e){e&&(r.metallicRoughnessTexture=e)})))}return Promise.all(i).then((function(){return a}))},e.prototype._getTextureSampler=function(e){var t={};if(!(e&&e instanceof d.Texture))return t;var r=this._getGLTFTextureWrapMode(e.wrapU);10497!==r&&(t.wrapS=r);var n=this._getGLTFTextureWrapMode(e.wrapV);switch(10497!==n&&(t.wrapT=n),e.samplingMode){case d.Texture.LINEAR_LINEAR:t.magFilter=9729,t.minFilter=9729;break;case d.Texture.LINEAR_NEAREST:t.magFilter=9729,t.minFilter=9728;break;case d.Texture.NEAREST_LINEAR:t.magFilter=9728,t.minFilter=9729;break;case d.Texture.NEAREST_LINEAR_MIPLINEAR:t.magFilter=9728,t.minFilter=9987;break;case d.Texture.NEAREST_NEAREST:t.magFilter=9728,t.minFilter=9728;break;case d.Texture.NEAREST_LINEAR_MIPNEAREST:t.magFilter=9728,t.minFilter=9985;break;case d.Texture.LINEAR_NEAREST_MIPNEAREST:t.magFilter=9729,t.minFilter=9984;break;case d.Texture.LINEAR_NEAREST_MIPLINEAR:t.magFilter=9729,t.minFilter=9986;break;case d.Texture.NEAREST_NEAREST_MIPLINEAR:t.magFilter=9728,t.minFilter=9986;break;case d.Texture.LINEAR_LINEAR_MIPLINEAR:t.magFilter=9729,t.minFilter=9987;break;case d.Texture.LINEAR_LINEAR_MIPNEAREST:t.magFilter=9729,t.minFilter=9985;break;case d.Texture.NEAREST_NEAREST_MIPNEAREST:t.magFilter=9728,t.minFilter=9984}return t},e.prototype._getGLTFTextureWrapMode=function(e){switch(e){case d.Texture.WRAP_ADDRESSMODE:return 10497;case d.Texture.CLAMP_ADDRESSMODE:return 33071;case d.Texture.MIRROR_ADDRESSMODE:return 33648;default:return d.Tools.Error("Unsupported Texture Wrap Mode ".concat(e,"!")),10497}},e.prototype._convertSpecGlossFactorsToMetallicRoughnessAsync=function(e,t,r,n){var i=this;return Promise.resolve().then((function(){var a={diffuseColor:e._albedoColor,specularColor:e._reflectivityColor,glossiness:e._microSurface},o=e._albedoTexture,s=e._reflectivityTexture,u=e._useMicroSurfaceFromReflectivityMapAlpha;if(s&&!u)return Promise.reject("_ConvertPBRMaterial: Glossiness values not included in the reflectivity texture are currently not supported");if((o||s)&&n){var l=i._exportTextureSampler(o||s);return i._convertSpecularGlossinessTexturesToMetallicRoughnessAsync(o,s,a,t).then((function(e){var n=i._exporter._textures;if(e.baseColorTextureData){var a=i._exportImage("baseColor".concat(n.length),t,e.baseColorTextureData);r.baseColorTexture=i._exportTextureInfo(a,l,null==o?void 0:o.coordinatesIndex)}return e.metallicRoughnessTextureData&&(a=i._exportImage("metallicRoughness".concat(n.length),t,e.metallicRoughnessTextureData),r.metallicRoughnessTexture=i._exportTextureInfo(a,l,null==s?void 0:s.coordinatesIndex)),e}))}return i._convertSpecularGlossinessToMetallicRoughness(a)}))},e.prototype._convertPBRMaterialAsync=function(e,t,r){var n=this,i={},a={name:e.name};if(e.isMetallicWorkflow()){var o=e._albedoColor,s=e.alpha;return o&&(i.baseColorFactor=[o.r,o.g,o.b,s]),this._convertMetalRoughFactorsToMetallicRoughnessAsync(e,t,i,r).then((function(o){return n._setMetallicRoughnessPbrMaterial(o,e,a,i,t,r)}))}return this._convertSpecGlossFactorsToMetallicRoughnessAsync(e,t,i,r).then((function(o){return n._setMetallicRoughnessPbrMaterial(o,e,a,i,t,r)}))},e.prototype._setMetallicRoughnessPbrMaterial=function(t,r,n,i,a,o){var s=this._exporter._materialMap,u=this._exporter._materials,l=[];if(t){if(e._SetAlphaMode(n,r),e._FuzzyEquals(t.baseColor,d.Color3.White(),e._Epsilon)&&r.alpha>=e._Epsilon||(i.baseColorFactor=[t.baseColor.r,t.baseColor.g,t.baseColor.b,r.alpha]),null!=t.metallic&&1!==t.metallic&&(i.metallicFactor=t.metallic),null!=t.roughness&&1!==t.roughness&&(i.roughnessFactor=t.roughness),null==r.backFaceCulling||r.backFaceCulling||(r._twoSidedLighting||d.Tools.Warn(r.name+": Back-face culling disabled and two-sided lighting disabled is not supported in glTF."),n.doubleSided=!0),o){var c=r._bumpTexture;if(c){var f=this._exportTextureAsync(c,a).then((function(e){e&&(n.normalTexture=e,1!==c.level&&(n.normalTexture.scale=c.level))}));l.push(f)}var h=r._ambientTexture;h&&(f=this._exportTextureAsync(h,a).then((function(e){if(e){var t={index:e.index,texCoord:e.texCoord,extensions:e.extensions};n.occlusionTexture=t;var i=r._ambientTextureStrength;i&&(t.strength=i)}})),l.push(f));var p=r._emissiveTexture;p&&(f=this._exportTextureAsync(p,a).then((function(e){e&&(n.emissiveTexture=e)})),l.push(f))}var _=r._emissiveColor;e._FuzzyEquals(_,d.Color3.Black(),e._Epsilon)||(n.emissiveFactor=_.asArray()),n.pbrMetallicRoughness=i,u.push(n),s[r.uniqueId]=u.length-1}return this._finishMaterial(l,n,r,a)},e.prototype._getPixelsFromTexture=function(e){return e.textureType,d.Constants.TEXTURETYPE_UNSIGNED_INT,e.readPixels()},e.prototype._exportTextureAsync=function(e,t){var r=this,n=this._exporter._extensionsPreExportTextureAsync("exporter",e,t);return n?n.then((function(n){return n?r._exportTextureInfoAsync(n,t):r._exportTextureInfoAsync(e,t)})):this._exportTextureInfoAsync(e,t)},e.prototype._exportTextureInfoAsync=function(e,t){return c(this,void 0,void 0,(function(){var r,n,i,a,o,s,u,l,h,p,_=this;return f(this,(function(m){switch(m.label){case 0:return(r=e.uid)in this._textureMap?[3,3]:[4,this._getPixelsFromTexture(e)];case 1:if(!(n=m.sent()))return[2,null];if(i=this._exportTextureSampler(e),a=e.mimeType)switch(a){case"image/jpeg":case"image/png":case"image/webp":t=a;break;default:d.Tools.Warn("Unsupported media type: ".concat(a))}return o=this._internalTextureToImage,s=e.getInternalTexture().uniqueId,o[s]||(o[s]={}),void 0===(u=o[s][t])&&(l=e.getSize(),u=c(_,void 0,void 0,(function(){var r;return f(this,(function(i){switch(i.label){case 0:return[4,this._getImageDataAsync(n,l.width,l.height,t)];case 1:return r=i.sent(),[2,this._exportImage(e.name,t,r)]}}))})),o[s][t]=u),p=this._exportTextureInfo,[4,u];case 2:h=p.apply(this,[m.sent(),i,e.coordinatesIndex]),this._textureMap[r]=h,this._exporter._extensionsPostExportTextures("exporter",this._textureMap[r],e),m.label=3;case 3:return[2,this._textureMap[r]]}}))}))},e.prototype._exportImage=function(e,t,r){var n=this._exporter._imageData,i=e.replace(/\.\/|\/|\.\\|\\/g,"_"),a=function(e){switch(e){case"image/jpeg":return".jpg";case"image/png":return".png";case"image/webp":return".webp";case"image/avif":return".avif"}}(t),o=i+a;o in n&&(o="".concat(i,"_").concat(d.Tools.RandomId()).concat(a)),n[o]={data:r,mimeType:t};var s=this._exporter._images;return s.push({name:e,uri:o}),s.length-1},e.prototype._exportTextureInfo=function(e,t,r){var n=this._exporter._textures,i=n.findIndex((function(r){return r.sampler==t&&r.source===e}));-1===i&&(i=n.length,n.push({source:e,sampler:t}));var a={index:i};return r&&(a.texCoord=r),a},e.prototype._exportTextureSampler=function(e){var t=this._getTextureSampler(e),r=this._exporter._samplers,n=r.findIndex((function(e){return e.minFilter===t.minFilter&&e.magFilter===t.magFilter&&e.wrapS===t.wrapS&&e.wrapT===t.wrapT}));return-1!==n?n:(r.push(t),r.length-1)},e._DielectricSpecular=new d.Color3(.04,.04,.04),e._MaxSpecularPower=1024,e._Epsilon=1e-6,e}(),m=function(){function e(){}return e._CreateBufferView=function(e,t,r,n,i){var a={buffer:e,byteLength:r};return t&&(a.byteOffset=t),i&&(a.name=i),n&&(a.byteStride=n),a},e._CreateAccessor=function(e,t,r,n,i,a,o,s){var u={name:t,bufferView:e,componentType:n,count:i,type:r};return null!=o&&(u.min=o),null!=s&&(u.max=s),null!=a&&(u.byteOffset=a),u},e._CalculateMinMaxPositions=function(e,t,r){var n,i,a=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];if(r)for(var s=t,u=t+r;s<u;++s){n=3*s,i=d.Vector3.FromArray(e,n).asArray();for(var l=0;l<3;++l){var c=i[l];c<a[l]&&(a[l]=c),c>o[l]&&(o[l]=c),++n}}return{min:a,max:o}},e._NormalizeTangentFromRef=function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);t>0&&(e.x/=t,e.y/=t,e.z/=t)},e._GetDataAccessorElementCount=function(e){switch(e){case"MAT2":case"VEC4":return 4;case"MAT3":return 9;case"MAT4":return 16;case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3}},e}();!function(e){e[e.INTANGENT=0]="INTANGENT",e[e.OUTTANGENT=1]="OUTTANGENT"}(p||(p={}));var g=function(){function e(){}return e._IsTransformable=function(e){return e&&(e instanceof d.TransformNode||e instanceof d.Camera||e instanceof d.Light)},e._CreateNodeAnimation=function(t,r,n,i,a){if(this._IsTransformable(t)){var o=[],s=[],u=r.getKeys(),l=e._CalculateMinMaxKeyFrames(u),c=e._DeduceInterpolation(u,n,i),f=c.interpolationType,h=c.shouldBakeAnimation;if(h?e._CreateBakedAnimation(t,r,n,l.min,l.max,r.framePerSecond,a,o,s,l,i):"LINEAR"===f||"STEP"===f?e._CreateLinearOrStepAnimation(t,r,n,o,s,i):"CUBICSPLINE"===f?e._CreateCubicSplineAnimation(t,r,n,o,s,i):e._CreateBakedAnimation(t,r,n,l.min,l.max,r.framePerSecond,a,o,s,l,i),o.length&&s.length)return{inputs:o,outputs:s,samplerInterpolation:f,inputsMin:h?l.min:d.Tools.FloatRound(l.min/r.framePerSecond),inputsMax:h?l.max:d.Tools.FloatRound(l.max/r.framePerSecond)}}return null},e._DeduceAnimationInfo=function(e){var t=null,r="VEC3",n=!1,i=e.targetProperty.split(".");switch(i[0]){case"scaling":t="scale";break;case"position":t="translation";break;case"rotation":r="VEC4",t="rotation";break;case"rotationQuaternion":r="VEC4",n=!0,t="rotation";break;case"influence":r="SCALAR",t="weights";break;default:d.Tools.Error("Unsupported animatable property ".concat(i[0]))}return t?{animationChannelTargetPath:t,dataAccessorType:r,useQuaternion:n}:(d.Tools.Error("animation channel target path and data accessor type could be deduced"),null)},e._CreateNodeAnimationFromNodeAnimations=function(t,r,n,i,a,o,s,u,l,c){var f;if(e._IsTransformable(t)&&t.animations)for(var h=0,p=t.animations;h<p.length;h++){var d=p[h];if(!c||c(d)){var _=e._DeduceAnimationInfo(d);_&&(f={name:d.name,samplers:[],channels:[]},e._AddAnimation("".concat(d.name),d.hasRunningRuntimeAnimations?r:f,t,d,_.dataAccessorType,_.animationChannelTargetPath,i,o,s,u,_.useQuaternion,l),f.samplers.length&&f.channels.length&&n.push(f))}}},e._CreateMorphTargetAnimationFromMorphTargetAnimations=function(t,r,n,i,a,o,s,u,l,c){var f;if(t instanceof d.Mesh){var h=t.morphTargetManager;if(h)for(var p=0;p<h.numTargets;++p)for(var _=0,m=h.getTarget(p).animations;_<m.length;_++){var g=m[_];if(!c||c(g)){for(var x=new d.Animation("".concat(g.name),"influence",g.framePerSecond,g.dataType,g.loopMode,g.enableBlending),y=[],T=g.getKeys(),v=0;v<T.length;++v)for(var b=T[v],A=0;A<h.numTargets;++A)A==p?y.push(b):y.push({frame:b.frame,value:0});x.setKeys(y);var E=e._DeduceAnimationInfo(x);E&&(f={name:x.name,samplers:[],channels:[]},e._AddAnimation(g.name,g.hasRunningRuntimeAnimations?r:f,t,x,E.dataAccessorType,E.animationChannelTargetPath,i,o,s,u,E.useQuaternion,l,h.numTargets),f.samplers.length&&f.channels.length&&n.push(f))}}}},e._CreateNodeAndMorphAnimationFromAnimationGroups=function(t,r,n,i,a,o,s,u){var l,c;if(t.animationGroups)for(var f=t.animationGroups,h=function(f){var h=new Map,_=new Map,m=new Set,g=f.to-f.from;c={name:f.name,channels:[],samplers:[]};for(var x=function(r){var g=f.targetedAnimations[r],x=g.target,y=g.animation;if(u&&!u(y))return"continue";if(p._IsTransformable(x)||1===x.length&&p._IsTransformable(x[0])){if(v=e._DeduceAnimationInfo(g.animation)){var T=p._IsTransformable(x)?x:p._IsTransformable(x[0])?x[0]:null;T&&e._AddAnimation("".concat(y.name),c,T,y,v.dataAccessorType,v.animationChannelTargetPath,n,i,a,o,v.useQuaternion,s)}}else if(x instanceof d.MorphTarget||1===x.length&&x[0]instanceof d.MorphTarget){var v;if(v=e._DeduceAnimationInfo(g.animation)){var b=x instanceof d.MorphTarget?x:x[0];if(b){var A=t.morphTargetManagers.find((function(e){for(var t=0;t<e.numTargets;++t)if(e.getTarget(t)===b)return!0;return!1}));if(A){var E=t.meshes.find((function(e){return e.morphTargetManager===A}));E&&(h.has(E)||h.set(E,new Map),null===(l=h.get(E))||void 0===l||l.set(b,y),m.add(E),_.set(E,y))}}}}},y=0;y<f.targetedAnimations.length;++y)x(y);m.forEach((function(t){for(var r=t.morphTargetManager,u=null,l=[],p=_.get(t).getKeys(),m=p.length,x=0;x<m;++x)for(var y=0;y<r.numTargets;++y){var T=r.getTarget(y),v=h.get(t);if(v){var b=v.get(T);b?(u||(u=new d.Animation("".concat(f.name,"_").concat(t.name,"_MorphWeightAnimation"),"influence",b.framePerSecond,d.Animation.ANIMATIONTYPE_FLOAT,b.loopMode,b.enableBlending)),l.push(b.getKeys()[x])):l.push({frame:f.from+g/m*x,value:T.influence,inTangent:p[0].inTangent?0:void 0,outTangent:p[0].outTangent?0:void 0})}}u.setKeys(l);var A=e._DeduceAnimationInfo(u);A&&e._AddAnimation("".concat(f.name,"_").concat(t.name,"_MorphWeightAnimation"),c,t,u,A.dataAccessorType,A.animationChannelTargetPath,n,i,a,o,A.useQuaternion,s,null==r?void 0:r.numTargets)})),c.channels.length&&c.samplers.length&&r.push(c)},p=this,_=0,m=f;_<m.length;_++)h(m[_])},e._AddAnimation=function(t,r,n,i,a,o,s,u,l,c,f,h,p){var d,_,g,x,y,T,v,b=e._CreateNodeAnimation(n,i,o,f,h);if(b){if(p){for(var A=0,E=0,M=[];b.inputs.length>0;)E=b.inputs.shift(),A%p==0&&M.push(E),A++;b.inputs=M}var F=s[n.uniqueId],w=4*b.inputs.length;d=m._CreateBufferView(0,u.getByteOffset(),w,void 0,"".concat(t,"  keyframe data view")),l.push(d),b.inputs.forEach((function(e){u.setFloat32(e)})),_=m._CreateAccessor(l.length-1,"".concat(t,"  keyframes"),"SCALAR",5126,b.inputs.length,null,[b.inputsMin],[b.inputsMax]),c.push(_),g=c.length-1,y=b.outputs.length,w=4*m._GetDataAccessorElementCount(a)*b.outputs.length,d=m._CreateBufferView(0,u.getByteOffset(),w,void 0,"".concat(t,"  data view")),l.push(d),b.outputs.forEach((function(e){e.forEach((function(e){u.setFloat32(e)}))})),_=m._CreateAccessor(l.length-1,"".concat(t,"  data"),a,5126,y,null,null,null),c.push(_),x=c.length-1,T={interpolation:b.samplerInterpolation,input:g,output:x},r.samplers.push(T),v={sampler:r.samplers.length-1,target:{node:F,path:o}},r.channels.push(v)}},e._CreateBakedAnimation=function(t,r,n,i,a,o,s,u,l,c,f){var h,p,_=d.Quaternion.Identity(),m=null,g=null,x=null,y=null,T=null,v=null;c.min=d.Tools.FloatRound(i/o);for(var b=r.getKeys(),A=0,E=b.length;A<E;++A){if(v=null,x=b[A],A+1<E)if(y=b[A+1],x.value.equals&&x.value.equals(y.value)||x.value===y.value){if(0!==A)continue;v=x.frame}else v=y.frame;else{if(T=b[A-1],x.value.equals&&x.value.equals(T.value)||x.value===T.value)continue;v=a}if(v)for(var M=x.frame;M<=v;M+=s)if((p=d.Tools.FloatRound(M/o))!==m){m=p,g=p;var F={key:0,repeatCount:0,loopMode:r.loopMode};h=r._interpolate(M,F),e._SetInterpolatedValue(t,h,p,r,n,_,u,l,f)}}g&&(c.max=g)},e._ConvertFactorToVector3OrQuaternion=function(t,r,n,i,a){var o=e._GetBasePositionRotationOrScale(r,i,a),s=n.targetProperty.split("."),u=s?s[1]:"",l=a?d.Quaternion.FromArray(o).normalize():d.Vector3.FromArray(o);switch(u){case"x":case"y":case"z":l[u]=t;break;case"w":l.w=t;break;default:d.Tools.Error('glTFAnimation: Unsupported component name "'.concat(u,'"!'))}return l},e._SetInterpolatedValue=function(e,t,r,n,i,a,o,s,u){var l;o.push(r),"weights"!==i?(n.dataType===d.Animation.ANIMATIONTYPE_FLOAT&&(t=this._ConvertFactorToVector3OrQuaternion(t,e,n,i,u)),"rotation"===i?(u?a=t:(l=t,d.Quaternion.RotationYawPitchRollToRef(l.y,l.x,l.z,a)),s.push(a.asArray())):(l=t,s.push(l.asArray()))):s.push([t])},e._CreateLinearOrStepAnimation=function(t,r,n,i,a,o){for(var s=0,u=r.getKeys();s<u.length;s++){var l=u[s];i.push(l.frame/r.framePerSecond),e._AddKeyframeValue(l,r,a,n,t,o)}},e._CreateCubicSplineAnimation=function(t,r,n,i,a,o){r.getKeys().forEach((function(s){i.push(s.frame/r.framePerSecond),e._AddSplineTangent(p.INTANGENT,a,n,"CUBICSPLINE",s,o),e._AddKeyframeValue(s,r,a,n,t,o),e._AddSplineTangent(p.OUTTANGENT,a,n,"CUBICSPLINE",s,o)}))},e._GetBasePositionRotationOrScale=function(e,t,r){var n;if("rotation"===t)if(r){var i=e.rotationQuaternion;n=(null!=i?i:d.Quaternion.Identity()).asArray()}else{var a=e.rotation;n=(null!=a?a:d.Vector3.Zero()).asArray()}else if("translation"===t){var o=e.position;n=(null!=o?o:d.Vector3.Zero()).asArray()}else{var s=e.scaling;n=(null!=s?s:d.Vector3.One()).asArray()}return n},e._AddKeyframeValue=function(e,t,r,n,i,a){var o,s=t.dataType;if(s===d.Animation.ANIMATIONTYPE_VECTOR3){var u=e.value.asArray();if("rotation"===n){var l=d.Vector3.FromArray(u);u=d.Quaternion.RotationYawPitchRoll(l.y,l.x,l.z).asArray()}r.push(u)}else if(s===d.Animation.ANIMATIONTYPE_FLOAT){if("weights"===n)r.push([e.value]);else if(o=this._ConvertFactorToVector3OrQuaternion(e.value,i,t,n,a)){if("rotation"===n){var c=a?o:d.Quaternion.RotationYawPitchRoll(o.y,o.x,o.z).normalize();r.push(c.asArray())}r.push(o.asArray())}}else s===d.Animation.ANIMATIONTYPE_QUATERNION?r.push(e.value.normalize().asArray()):d.Tools.Error("glTFAnimation: Unsupported key frame values for animation!")},e._DeduceInterpolation=function(e,t,r){var n,i,a=!1;if("rotation"===t&&!r)return{interpolationType:"LINEAR",shouldBakeAnimation:!0};for(var o=0,s=e.length;o<s;++o)if((i=e[o]).inTangent||i.outTangent)if(n){if("CUBICSPLINE"!==n){n="LINEAR",a=!0;break}}else n="CUBICSPLINE";else if(n){if("CUBICSPLINE"===n||i.interpolation&&i.interpolation===d.AnimationKeyInterpolation.STEP&&"STEP"!==n){n="LINEAR",a=!0;break}}else n=i.interpolation&&i.interpolation===d.AnimationKeyInterpolation.STEP?"STEP":"LINEAR";return n||(n="LINEAR"),{interpolationType:n,shouldBakeAnimation:a}},e._AddSplineTangent=function(e,t,r,n,i,a){var o,s=e===p.INTANGENT?i.inTangent:i.outTangent;if("CUBICSPLINE"===n){if("rotation"===r)if(s)if(a)o=s.asArray();else{var u=s;o=d.Quaternion.RotationYawPitchRoll(u.y,u.x,u.z).asArray()}else o=[0,0,0,0];else o="weights"===r?s?[s]:[0]:s?s.asArray():[0,0,0];t.push(o)}},e._CalculateMinMaxKeyFrames=function(e){var t=1/0,r=-1/0;return e.forEach((function(e){t=Math.min(t,e.frame),r=Math.max(r,e.frame)})),{min:t,max:r}},e}(),x=d.Matrix.Compose(new d.Vector3(-1,1,1),d.Quaternion.Identity(),d.Vector3.Zero()),y=new d.Quaternion(0,1,0,0);function T(e,t){if(!(e instanceof d.TransformNode))return!1;if(t){if(!e.getWorldMatrix().isIdentity())return!1}else if(!e.getWorldMatrix().multiplyToRef(x,d.TmpVectors.Matrix[0]).isIdentity())return!1;return!(e instanceof d.Mesh&&e.geometry||e instanceof d.InstancedMesh&&e.sourceMesh.geometry)}var v=function(){function e(e,t){this._extensions={},this._glTF={asset:{generator:"Babylon.js v".concat(d.Engine.Version),version:"2.0"}},(e=e||d.EngineStore.LastCreatedScene)&&(this._babylonScene=e,this._bufferViews=[],this._accessors=[],this._meshes=[],this._scenes=[],this._cameras=[],this._nodes=[],this._images=[],this._materials=[],this._materialMap=[],this._textures=[],this._samplers=[],this._skins=[],this._animations=[],this._imageData={},this._orderedImageData=[],this._options=t||{},this._animationSampleRate=this._options.animationSampleRate||1/60,this._glTFMaterialExporter=new _(this),this._loadExtensions())}return e.prototype._applyExtension=function(e,t,r,n){var i=this;if(r>=t.length)return Promise.resolve(e);var a=n(t[r],e);return a?a.then((function(e){return i._applyExtension(e,t,r+1,n)})):this._applyExtension(e,t,r+1,n)},e.prototype._applyExtensions=function(t,r){for(var n=[],i=0,a=e._ExtensionNames;i<a.length;i++){var o=a[i];n.push(this._extensions[o])}return this._applyExtension(t,n,0,r)},e.prototype._extensionsPreExportTextureAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.preExportTextureAsync&&t.preExportTextureAsync(e,n,r)}))},e.prototype._extensionsPostExportMeshPrimitiveAsync=function(e,t,r,n){return this._applyExtensions(t,(function(t,i){return t.postExportMeshPrimitiveAsync&&t.postExportMeshPrimitiveAsync(e,i,r,n)}))},e.prototype._extensionsPostExportNodeAsync=function(e,t,r,n,i){return this._applyExtensions(t,(function(t,a){return t.postExportNodeAsync&&t.postExportNodeAsync(e,a,r,n,i)}))},e.prototype._extensionsPostExportMaterialAsync=function(e,t,r){return this._applyExtensions(t,(function(t,n){return t.postExportMaterialAsync&&t.postExportMaterialAsync(e,n,r)}))},e.prototype._extensionsPostExportMaterialAdditionalTextures=function(t,r,n){for(var i=[],a=0,o=e._ExtensionNames;a<o.length;a++){var s=o[a],u=this._extensions[s];u.postExportMaterialAdditionalTextures&&i.push.apply(i,u.postExportMaterialAdditionalTextures(t,r,n))}return i},e.prototype._extensionsPostExportTextures=function(t,r,n){for(var i=0,a=e._ExtensionNames;i<a.length;i++){var o=a[i],s=this._extensions[o];s.postExportTexture&&s.postExportTexture(t,r,n)}},e.prototype._forEachExtensions=function(t){for(var r=0,n=e._ExtensionNames;r<n.length;r++){var i=n[r],a=this._extensions[i];a.enabled&&t(a)}},e.prototype._extensionsOnExporting=function(){var e=this;this._forEachExtensions((function(t){t.wasUsed&&(null==e._glTF.extensionsUsed&&(e._glTF.extensionsUsed=[]),-1===e._glTF.extensionsUsed.indexOf(t.name)&&e._glTF.extensionsUsed.push(t.name),t.required&&(null==e._glTF.extensionsRequired&&(e._glTF.extensionsRequired=[]),-1===e._glTF.extensionsRequired.indexOf(t.name)&&e._glTF.extensionsRequired.push(t.name)),null==e._glTF.extensions&&(e._glTF.extensions={}),t.onExporting&&t.onExporting())}))},e.prototype._loadExtensions=function(){for(var t=0,r=e._ExtensionNames;t<r.length;t++){var n=r[t],i=e._ExtensionFactories[n](this);this._extensions[n]=i}},e.prototype.dispose=function(){for(var e in this._extensions)this._extensions[e].dispose()},Object.defineProperty(e.prototype,"options",{get:function(){return this._options},enumerable:!1,configurable:!0}),e.RegisterExtension=function(t,r){e.UnregisterExtension(t)&&d.Tools.Warn("Extension with the name ".concat(t," already exists")),e._ExtensionFactories[t]=r,e._ExtensionNames.push(t)},e.UnregisterExtension=function(t){if(!e._ExtensionFactories[t])return!1;delete e._ExtensionFactories[t];var r=e._ExtensionNames.indexOf(t);return-1!==r&&e._ExtensionNames.splice(r,1),!0},e.prototype._reorderIndicesBasedOnPrimitiveMode=function(e,t,r,n,i){switch(t){case d.Material.TriangleFillMode:n||(n=0);for(var a=e.indexStart,o=e.indexStart+e.indexCount;a<o;a+=3){var s=n+4*a,u=i.getUInt32(s+4),l=i.getUInt32(s+8);i.setUInt32(l,s+4),i.setUInt32(u,s+8)}break;case d.Material.TriangleFanDrawMode:a=e.indexStart+e.indexCount-1;for(var c=e.indexStart;a>=c;--a)i.setUInt32(r[a],n),n+=4;break;case d.Material.TriangleStripDrawMode:e.indexCount>=3&&(i.setUInt32(r[e.indexStart+2],n+4),i.setUInt32(r[e.indexStart+1],n+8))}},e.prototype._reorderVertexAttributeDataBasedOnPrimitiveMode=function(e,t,r,n,i,a){switch(t){case d.Material.TriangleFillMode:this._reorderTriangleFillMode(e,r,n,i,a);break;case d.Material.TriangleStripDrawMode:this._reorderTriangleStripDrawMode(e,r,n,i,a);break;case d.Material.TriangleFanDrawMode:this._reorderTriangleFanMode(e,r,n,i,a)}},e.prototype._reorderTriangleFillMode=function(e,t,r,n,i){var a=this._getVertexBufferFromMesh(t,e.getMesh());if(a){var o=a.byteStride/d.VertexBuffer.GetTypeByteLength(a.type);if(e.verticesCount%3!=0)d.Tools.Error("The submesh vertices for the triangle fill mode is not divisible by 3!");else{var s=[],u=0;switch(t){case d.VertexBuffer.PositionKind:case d.VertexBuffer.NormalKind:for(var l=e.verticesStart;l<e.verticesStart+e.verticesCount;l+=3)u=l*o,s.push(d.Vector3.FromArray(r,u)),s.push(d.Vector3.FromArray(r,u+2*o)),s.push(d.Vector3.FromArray(r,u+o));break;case d.VertexBuffer.TangentKind:for(l=e.verticesStart;l<e.verticesStart+e.verticesCount;l+=3)u=l*o,s.push(d.Vector4.FromArray(r,u)),s.push(d.Vector4.FromArray(r,u+2*o)),s.push(d.Vector4.FromArray(r,u+o));break;case d.VertexBuffer.ColorKind:var c=a.getSize();for(l=e.verticesStart;l<e.verticesStart+e.verticesCount;l+=c)u=l*o,4===c?(s.push(d.Vector4.FromArray(r,u)),s.push(d.Vector4.FromArray(r,u+2*o)),s.push(d.Vector4.FromArray(r,u+o))):(s.push(d.Vector3.FromArray(r,u)),s.push(d.Vector3.FromArray(r,u+2*o)),s.push(d.Vector3.FromArray(r,u+o)));break;case d.VertexBuffer.UVKind:case d.VertexBuffer.UV2Kind:for(l=e.verticesStart;l<e.verticesStart+e.verticesCount;l+=3)u=l*o,s.push(d.Vector2.FromArray(r,u)),s.push(d.Vector2.FromArray(r,u+2*o)),s.push(d.Vector2.FromArray(r,u+o));break;default:d.Tools.Error("Unsupported Vertex Buffer type: ".concat(t))}this._writeVertexAttributeData(s,n,t,i)}}else d.Tools.Warn("reorderTriangleFillMode: Vertex Buffer Kind ".concat(t," not present!"))},e.prototype._reorderTriangleStripDrawMode=function(e,t,r,n,i){var a=this._getVertexBufferFromMesh(t,e.getMesh());if(a){var o=a.byteStride/d.VertexBuffer.GetTypeByteLength(a.type),s=[],u=0;switch(t){case d.VertexBuffer.PositionKind:case d.VertexBuffer.NormalKind:u=e.verticesStart,s.push(d.Vector3.FromArray(r,u+2*o)),s.push(d.Vector3.FromArray(r,u+o));break;case d.VertexBuffer.TangentKind:for(var l=e.verticesStart+e.verticesCount-1;l>=e.verticesStart;--l)u=l*o,s.push(d.Vector4.FromArray(r,u));break;case d.VertexBuffer.ColorKind:for(l=e.verticesStart+e.verticesCount-1;l>=e.verticesStart;--l)u=l*o,4===a.getSize()?s.push(d.Vector4.FromArray(r,u)):s.push(d.Vector3.FromArray(r,u));break;case d.VertexBuffer.UVKind:case d.VertexBuffer.UV2Kind:for(l=e.verticesStart+e.verticesCount-1;l>=e.verticesStart;--l)u=l*o,s.push(d.Vector2.FromArray(r,u));break;default:d.Tools.Error("Unsupported Vertex Buffer type: ".concat(t))}this._writeVertexAttributeData(s,n+12,t,i)}else d.Tools.Warn("reorderTriangleStripDrawMode: Vertex buffer kind ".concat(t," not present!"))},e.prototype._reorderTriangleFanMode=function(e,t,r,n,i){var a=this._getVertexBufferFromMesh(t,e.getMesh());if(a){var o=a.byteStride/d.VertexBuffer.GetTypeByteLength(a.type),s=[],u=0;switch(t){case d.VertexBuffer.PositionKind:case d.VertexBuffer.NormalKind:for(var l=e.verticesStart+e.verticesCount-1;l>=e.verticesStart;--l)u=l*o,s.push(d.Vector3.FromArray(r,u));break;case d.VertexBuffer.TangentKind:for(l=e.verticesStart+e.verticesCount-1;l>=e.verticesStart;--l)u=l*o,s.push(d.Vector4.FromArray(r,u));break;case d.VertexBuffer.ColorKind:for(l=e.verticesStart+e.verticesCount-1;l>=e.verticesStart;--l)u=l*o,s.push(d.Vector4.FromArray(r,u)),4===a.getSize()?s.push(d.Vector4.FromArray(r,u)):s.push(d.Vector3.FromArray(r,u));break;case d.VertexBuffer.UVKind:case d.VertexBuffer.UV2Kind:for(l=e.verticesStart+e.verticesCount-1;l>=e.verticesStart;--l)u=l*o,s.push(d.Vector2.FromArray(r,u));break;default:d.Tools.Error("Unsupported Vertex Buffer type: ".concat(t))}this._writeVertexAttributeData(s,n,t,i)}else d.Tools.Warn("reorderTriangleFanMode: Vertex buffer kind ".concat(t," not present!"))},e.prototype._writeVertexAttributeData=function(e,t,r,n){for(var i=0,a=e;i<a.length;i++){var o=a[i];r===d.VertexBuffer.NormalKind?o.normalize():r===d.VertexBuffer.TangentKind&&o instanceof d.Vector4&&m._NormalizeTangentFromRef(o);for(var s=0,u=o.asArray();s<u.length;s++){var l=u[s];n.setFloat32(l,t),t+=4}}},e.prototype._writeAttributeData=function(e,t,r,n,i,a){var o,s,u=[];switch(e){case d.VertexBuffer.PositionKind:for(var l=0,c=r.length/n;l<c;++l){o=l*n;var f=d.Vector3.FromArray(r,o);u.push(f.asArray())}break;case d.VertexBuffer.NormalKind:l=0;for(var h=r.length/n;l<h;++l)o=l*n,f=d.Vector3.FromArray(r,o),u.push(f.normalize().asArray());break;case d.VertexBuffer.TangentKind:l=0;for(var p=r.length/n;l<p;++l)o=l*n,f=d.Vector4.FromArray(r,o),m._NormalizeTangentFromRef(f),u.push(f.asArray());break;case d.VertexBuffer.ColorKind:for(var _=a.material,g=!_||"StandardMaterial"===_.getClassName(),x=(f=3===n?new d.Color3:new d.Color4,this._babylonScene.getEngine().useExactSrgbConversions),y=(l=0,r.length/n);l<y;++l)o=l*n,3===n?(d.Color3.FromArrayToRef(r,o,f),g&&f.toLinearSpaceToRef(f,x)):(d.Color4.FromArrayToRef(r,o,f),g&&f.toLinearSpaceToRef(f,x)),u.push(f.asArray());break;case d.VertexBuffer.UVKind:case d.VertexBuffer.UV2Kind:l=0;for(var T=r.length/n;l<T;++l)o=l*n,f=d.Vector2.FromArray(r,o),u.push(f.asArray());break;case d.VertexBuffer.MatricesIndicesKind:case d.VertexBuffer.MatricesIndicesExtraKind:l=0;for(var v=r.length/n;l<v;++l)o=l*n,f=d.Vector4.FromArray(r,o),u.push(f.asArray());break;case d.VertexBuffer.MatricesWeightsKind:case d.VertexBuffer.MatricesWeightsExtraKind:l=0;for(var b=r.length/n;l<b;++l)o=l*n,f=d.Vector4.FromArray(r,o),u.push(f.asArray());break;default:d.Tools.Warn("Unsupported Vertex Buffer Type: "+e),u=[]}switch(t){case 5121:s=i.setUInt8.bind(i);break;case 5123:s=i.setUInt16.bind(i);break;case 5125:s=i.setUInt32.bind(i);break;case 5126:s=i.setFloat32.bind(i);break;default:return void d.Tools.Warn("Unsupported Attribute Component kind: "+t)}for(var A=0,E=u;A<E.length;A++)for(var M=0,F=E[A];M<F.length;M++)s(F[M])},e.prototype.writeMorphTargetAttributeData=function(e,t,r,n,i,a,o,s){var u,l,c=[],f=new d.Vector3,h=new d.Vector4(0,0,0,0);switch(e){case d.VertexBuffer.PositionKind:for(var p=r.verticesStart;p<r.verticesCount;++p){u=r.indexStart+p*a;var _=d.Vector3.FromArray(n,u);f=(g=d.Vector3.FromArray(i,u)).subtractToRef(_,f),s&&(s.min.copyFromFloats(Math.min(f.x,s.min.x),Math.min(f.y,s.min.y),Math.min(f.z,s.min.z)),s.max.copyFromFloats(Math.max(f.x,s.max.x),Math.max(f.y,s.max.y),Math.max(f.z,s.max.z))),c.push(f.asArray())}break;case d.VertexBuffer.NormalKind:for(p=r.verticesStart;p<r.verticesCount;++p)u=r.indexStart+p*a,_=d.Vector3.FromArray(n,u).normalize(),f=(g=d.Vector3.FromArray(i,u).normalize()).subtractToRef(_,f),c.push(f.asArray());break;case d.VertexBuffer.TangentKind:for(p=r.verticesStart;p<r.verticesCount;++p){u=r.indexStart+p*(a+1),_=d.Vector4.FromArray(n,u),m._NormalizeTangentFromRef(_);var g=d.Vector4.FromArray(i,u);m._NormalizeTangentFromRef(g),h=g.subtractToRef(_,h),c.push([h.x,h.y,h.z])}break;default:d.Tools.Warn("Unsupported Vertex Buffer Type: "+e),c=[]}switch(t){case 5121:l=o.setUInt8.bind(o);break;case 5123:l=o.setUInt16.bind(o);break;case 5125:l=o.setUInt32.bind(o);break;case 5126:l=o.setFloat32.bind(o);break;default:return void d.Tools.Warn("Unsupported Attribute Component kind: "+t)}for(var x=0,y=c;x<y.length;x++)for(var T=0,v=y[x];T<v.length;T++)l(v[T])},e.prototype._generateJSON=function(e,t,r){var n,i,a,o=this,s={byteLength:this._totalByteLength},u=this._totalByteLength;return s.byteLength&&(this._glTF.buffers=[s]),this._nodes&&this._nodes.length&&(this._glTF.nodes=this._nodes),this._meshes&&this._meshes.length&&(this._glTF.meshes=this._meshes),this._scenes&&this._scenes.length&&(this._glTF.scenes=this._scenes,this._glTF.scene=0),this._cameras&&this._cameras.length&&(this._glTF.cameras=this._cameras),this._bufferViews&&this._bufferViews.length&&(this._glTF.bufferViews=this._bufferViews),this._accessors&&this._accessors.length&&(this._glTF.accessors=this._accessors),this._animations&&this._animations.length&&(this._glTF.animations=this._animations),this._materials&&this._materials.length&&(this._glTF.materials=this._materials),this._textures&&this._textures.length&&(this._glTF.textures=this._textures),this._samplers&&this._samplers.length&&(this._glTF.samplers=this._samplers),this._skins&&this._skins.length&&(this._glTF.skins=this._skins),this._images&&this._images.length&&(e?(this._glTF.images=[],this._images.forEach((function(e){e.uri&&(i=o._imageData[e.uri],o._orderedImageData.push(i),n=e.uri.split(".")[0]+" image",a=m._CreateBufferView(0,u,i.data.byteLength,void 0,n),u+=i.data.byteLength,o._bufferViews.push(a),e.bufferView=o._bufferViews.length-1,e.name=n,e.mimeType=i.mimeType,e.uri=void 0,o._glTF.images||(o._glTF.images=[]),o._glTF.images.push(e))})),s.byteLength=u):this._glTF.images=this._images),e||(s.uri=t+".bin"),r?JSON.stringify(this._glTF,null,2):JSON.stringify(this._glTF)},e.prototype._generateGLTFAsync=function(e,t){var r=this;return void 0===t&&(t=!0),this._generateBinaryAsync().then((function(n){r._extensionsOnExporting();var i=r._generateJSON(!1,e,!0),a=new Blob([n],{type:"application/octet-stream"}),o=e+".gltf",s=e+".bin",u=new l;if(u.glTFFiles[o]=i,u.glTFFiles[s]=a,r._imageData)for(var c in r._imageData)u.glTFFiles[c]=new Blob([r._imageData[c].data],{type:r._imageData[c].mimeType});return t&&r.dispose(),u}))},e.prototype._generateBinaryAsync=function(){var e=this,t=new b(4);return this._createSceneAsync(t).then((function(){return e._localEngine&&e._localEngine.dispose(),t.getArrayBuffer()}))},e.prototype._getPadding=function(e){var t=e%4;return 0===t?t:4-t},e.prototype._generateGLBAsync=function(e,t){var r=this;return void 0===t&&(t=!0),this._generateBinaryAsync().then((function(n){r._extensionsOnExporting();var i,a=r._generateJSON(!0),o=e+".glb",s=a.length,u=0;"undefined"!=typeof TextEncoder&&(s=(i=(new TextEncoder).encode(a)).length);for(var c=0;c<r._orderedImageData.length;++c)u+=r._orderedImageData[c].data.byteLength;var f=r._getPadding(s),h=r._getPadding(n.byteLength),p=r._getPadding(u),d=28+s+f+n.byteLength+h+u+p,_=new ArrayBuffer(12),m=new DataView(_);m.setUint32(0,1179937895,!0),m.setUint32(4,2,!0),m.setUint32(8,d,!0);var g=new ArrayBuffer(8+s+f),x=new DataView(g);x.setUint32(0,s+f,!0),x.setUint32(4,1313821514,!0);var y=new Uint8Array(g,8);if(i)y.set(i);else{var T="_".charCodeAt(0);for(c=0;c<s;++c){var v=a.charCodeAt(c);v!=a.codePointAt(c)?y[c]=T:y[c]=v}}var b=new Uint8Array(g,8+s);for(c=0;c<f;++c)b[c]=32;var A=new ArrayBuffer(8),E=new DataView(A);E.setUint32(0,n.byteLength+u+p,!0),E.setUint32(4,5130562,!0);var M=new ArrayBuffer(h),F=new Uint8Array(M);for(c=0;c<h;++c)F[c]=0;var w=new ArrayBuffer(p),C=new Uint8Array(w);for(c=0;c<p;++c)C[c]=0;var R=[_,g,A,n];for(c=0;c<r._orderedImageData.length;++c)R.push(r._orderedImageData[c].data);R.push(M),R.push(w);var V=new Blob(R,{type:"application/octet-stream"}),S=new l;return S.glTFFiles[o]=V,null!=r._localEngine&&r._localEngine.dispose(),t&&r.dispose(),S}))},e.prototype._setNodeTransformation=function(e,t){t.getPivotPoint().equalsToFloats(0,0,0)||d.Tools.Warn("Pivot points are not supported in the glTF serializer"),t.position.equalsToFloats(0,0,0)||(e.translation=t.position.asArray()),t.scaling.equalsToFloats(1,1,1)||(e.scale=t.scaling.asArray());var r=d.Quaternion.FromEulerAngles(t.rotation.x,t.rotation.y,t.rotation.z);t.rotationQuaternion&&r.multiplyInPlace(t.rotationQuaternion),d.Quaternion.IsIdentity(r)||(e.rotation=r.normalize().asArray())},e.prototype._setCameraTransformation=function(e,t){var r=d.TmpVectors.Vector3[0],n=d.TmpVectors.Quaternion[0];t.getWorldMatrix().decompose(void 0,n,r),r.equalsToFloats(0,0,0)||(e.translation=r.asArray()),n.multiplyInPlace(y),d.Quaternion.IsIdentity(n)||(e.rotation=n.asArray())},e.prototype._getVertexBufferFromMesh=function(e,t){if(t.isVerticesDataPresent(e,!0)){var r=t.getVertexBuffer(e,!0);if(r)return r}return null},e.prototype._createBufferViewKind=function(e,t,r,n,i){var a=r instanceof d.Mesh?r:r instanceof d.InstancedMesh?r.sourceMesh:null;if(a){var o=a.getVertexBuffer(e,!0),s=a.getVerticesData(e,void 0,void 0,!0);if(o&&s){var u=d.VertexBuffer.GetTypeByteLength(t),l=s.length*u,c=m._CreateBufferView(0,n.getByteOffset(),l,i,e+" - "+a.name);this._bufferViews.push(c),this._writeAttributeData(e,t,s,i/u,n,r)}}},e.prototype._setMorphTargetAttributes=function(e,t,r,n){if(r){t.targets||(t.targets=[]);var i={},a=e.getMesh();if(r.hasNormals){var o=a.getVerticesData(d.VertexBuffer.NormalKind,void 0,void 0,!0),s=r.getNormals(),u=(g=e.verticesCount)*(x=12),l=m._CreateBufferView(0,n.getByteOffset(),u,x,r.name+"_NORMAL");this._bufferViews.push(l);var c=this._bufferViews.length-1,f=m._CreateAccessor(c,r.name+" - NORMAL","VEC3",5126,g,0,null,null);this._accessors.push(f),i.NORMAL=this._accessors.length-1,this.writeMorphTargetAttributeData(d.VertexBuffer.NormalKind,5126,e,o,s,x/4,n)}if(r.hasPositions){var h=a.getVerticesData(d.VertexBuffer.PositionKind,void 0,void 0,!0),p=r.getPositions();u=(g=e.verticesCount)*(x=12),l=m._CreateBufferView(0,n.getByteOffset(),u,x,r.name+"_POSITION"),this._bufferViews.push(l),c=this._bufferViews.length-1;var _={min:new d.Vector3(1/0,1/0,1/0),max:new d.Vector3(-1/0,-1/0,-1/0)};f=m._CreateAccessor(c,r.name+" - POSITION","VEC3",5126,g,0,null,null),this._accessors.push(f),i.POSITION=this._accessors.length-1,this.writeMorphTargetAttributeData(d.VertexBuffer.PositionKind,5126,e,h,p,x/4,n,_),f.min=_.min.asArray(),f.max=_.max.asArray()}if(r.hasTangents){var g,x,y=a.getVerticesData(d.VertexBuffer.TangentKind,void 0,void 0,!0),T=r.getTangents();u=(g=e.verticesCount)*(x=12),l=m._CreateBufferView(0,n.getByteOffset(),u,x,r.name+"_NORMAL"),this._bufferViews.push(l),c=this._bufferViews.length-1,f=m._CreateAccessor(c,r.name+" - TANGENT","VEC3",5126,g,0,null,null),this._accessors.push(f),i.TANGENT=this._accessors.length-1,this.writeMorphTargetAttributeData(d.VertexBuffer.TangentKind,5126,e,y,T,x/4,n)}t.targets.push(i)}},e.prototype._getMeshPrimitiveMode=function(e){if(e instanceof d.LinesMesh)return d.Material.LineListDrawMode;if(e instanceof d.InstancedMesh||e instanceof d.Mesh){var t=e instanceof d.Mesh?e:e.sourceMesh;if("number"==typeof t.overrideRenderingFillMode)return t.overrideRenderingFillMode}return e.material?e.material.fillMode:d.Material.TriangleFillMode},e.prototype._setPrimitiveMode=function(e,t){switch(t){case d.Material.TriangleFillMode:break;case d.Material.TriangleStripDrawMode:e.mode=5;break;case d.Material.TriangleFanDrawMode:e.mode=6;break;case d.Material.PointListDrawMode:case d.Material.PointFillMode:e.mode=0;break;case d.Material.LineLoopDrawMode:e.mode=2;break;case d.Material.LineListDrawMode:e.mode=1;break;case d.Material.LineStripDrawMode:e.mode=3}},e.prototype._setAttributeKind=function(e,t){switch(t){case d.VertexBuffer.PositionKind:e.attributes.POSITION=this._accessors.length-1;break;case d.VertexBuffer.NormalKind:e.attributes.NORMAL=this._accessors.length-1;break;case d.VertexBuffer.ColorKind:e.attributes.COLOR_0=this._accessors.length-1;break;case d.VertexBuffer.TangentKind:e.attributes.TANGENT=this._accessors.length-1;break;case d.VertexBuffer.UVKind:e.attributes.TEXCOORD_0=this._accessors.length-1;break;case d.VertexBuffer.UV2Kind:e.attributes.TEXCOORD_1=this._accessors.length-1;break;case d.VertexBuffer.MatricesIndicesKind:e.attributes.JOINTS_0=this._accessors.length-1;break;case d.VertexBuffer.MatricesIndicesExtraKind:e.attributes.JOINTS_1=this._accessors.length-1;break;case d.VertexBuffer.MatricesWeightsKind:e.attributes.WEIGHTS_0=this._accessors.length-1;break;case d.VertexBuffer.MatricesWeightsExtraKind:e.attributes.WEIGHTS_1=this._accessors.length-1;break;default:d.Tools.Warn("Unsupported Vertex Buffer Type: "+t)}},e.prototype._setPrimitiveAttributesAsync=function(e,t,r){var n,i,a=[],o=null;t instanceof d.Mesh?o=t:t instanceof d.InstancedMesh&&(o=t.sourceMesh);var s=[{kind:d.VertexBuffer.PositionKind,accessorType:"VEC3",accessorComponentType:5126,byteStride:12},{kind:d.VertexBuffer.NormalKind,accessorType:"VEC3",accessorComponentType:5126,byteStride:12},{kind:d.VertexBuffer.ColorKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:d.VertexBuffer.TangentKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:d.VertexBuffer.UVKind,accessorType:"VEC2",accessorComponentType:5126,byteStride:8},{kind:d.VertexBuffer.UV2Kind,accessorType:"VEC2",accessorComponentType:5126,byteStride:8},{kind:d.VertexBuffer.MatricesIndicesKind,accessorType:"VEC4",accessorComponentType:5123,byteStride:8},{kind:d.VertexBuffer.MatricesIndicesExtraKind,accessorType:"VEC4",accessorComponentType:5123,byteStride:8},{kind:d.VertexBuffer.MatricesWeightsKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16},{kind:d.VertexBuffer.MatricesWeightsExtraKind,accessorType:"VEC4",accessorComponentType:5126,byteStride:16}];if(o){for(var u=null,l=this._getMeshPrimitiveMode(o),c={},f=o.morphTargetManager,h=0,p=s;h<p.length;h++){var _=(G=p[h]).kind,g=G.accessorComponentType;if(o.isVerticesDataPresent(_,!0)){var x=this._getVertexBufferFromMesh(_,o);G.byteStride=x?x.getSize()*d.VertexBuffer.GetTypeByteLength(G.accessorComponentType):4*d.VertexBuffer.DeduceStride(_),12===G.byteStride&&(G.accessorType="VEC3"),this._createBufferViewKind(_,g,t,r,G.byteStride),G.bufferViewIndex=this._bufferViews.length-1,c[_]=G.bufferViewIndex}}if(o.getTotalIndices()){var y=o.getIndices();if(y){var T=4*y.length;n=m._CreateBufferView(0,r.getByteOffset(),T,void 0,"Indices - "+o.name),this._bufferViews.push(n),u=this._bufferViews.length-1;for(var v=0,b=y.length;v<b;++v)r.setUInt32(y[v])}}if(o.subMeshes)for(var A=0,E=o.subMeshes;A<E.length;A++){var M=E[A],F=M.getMaterial()||o.getScene().defaultMaterial,w=null;if(F)if(o instanceof d.LinesMesh){var C={name:o.name+" material"};(!o.color.equals(d.Color3.White())||o.alpha<1)&&(C.pbrMetallicRoughness={baseColorFactor:o.color.asArray().concat([o.alpha])}),this._materials.push(C),w=this._materials.length-1}else if(F instanceof d.MultiMaterial){var R=F.subMaterials[M.materialIndex];R&&(F=R,w=this._materialMap[F.uniqueId])}else w=this._materialMap[F.uniqueId];var V=null!=w?this._materials[w]:null,S={attributes:{}};this._setPrimitiveMode(S,l);for(var I=0,B=s;I<B.length;I++)if(((_=(G=B[I]).kind)!==d.VertexBuffer.UVKind&&_!==d.VertexBuffer.UV2Kind||this._options.exportUnusedUVs||V&&this._glTFMaterialExporter._hasTexturesPresent(V))&&(D=o.getVerticesData(_,void 0,void 0,!0))&&(x=this._getVertexBufferFromMesh(_,o))){var P=x.getSize(),N=G.bufferViewIndex;if(null!=N){i={min:null,max:null},_==d.VertexBuffer.PositionKind&&(i=m._CalculateMinMaxPositions(D,0,D.length/P));var O=m._CreateAccessor(N,_+" - "+t.name,G.accessorType,G.accessorComponentType,D.length/P,0,i.min,i.max);this._accessors.push(O),this._setAttributeKind(S,_)}}if(u&&(O=m._CreateAccessor(u,"indices - "+t.name,"SCALAR",5125,M.indexCount,4*M.indexStart,null,null),this._accessors.push(O),S.indices=this._accessors.length-1),Object.keys(S.attributes).length>0){if((null!==o.overrideMaterialSideOrientation?o.overrideMaterialSideOrientation:F.sideOrientation)===(this._babylonScene.useRightHandedSystem?d.Material.ClockWiseSideOrientation:d.Material.CounterClockWiseSideOrientation)){var L=null!=u?this._bufferViews[u].byteOffset:null;null==L&&(L=0);var U=null;if(null!=u&&(U=o.getIndices()),U)this._reorderIndicesBasedOnPrimitiveMode(M,l,U,L,r);else for(var k=0,K=s;k<K.length;k++){var D,G=K[k];if(D=o.getVerticesData(G.kind,void 0,void 0,!0)){var W=this._bufferViews[c[G.kind]].byteOffset||0;this._reorderVertexAttributeDataBasedOnPrimitiveMode(M,l,G.kind,D,W,r)}}}null!=w&&(S.material=w)}if(f){e.extras||(e.extras={}),e.extras.targetNames=[];for(var z=0;z<f.numTargets;++z){var q=f.getTarget(z);this._setMorphTargetAttributes(M,S,q,r),e.extras.targetNames.push(q.name)}}e.primitives.push(S),this._extensionsPostExportMeshPrimitiveAsync("postExport",S,M,r),a.push()}}return Promise.all(a).then((function(){}))},e.prototype._createSceneAsync=function(e){var t,r,n,i,a,o=this,s={nodes:[]},u=h(h(h(h([],this._babylonScene.transformNodes,!0),this._babylonScene.meshes,!0),this._babylonScene.lights,!0),this._babylonScene.cameras,!0),l=new Set;if(this._babylonScene.metadata&&(this._options.metadataSelector?s.extras=this._options.metadataSelector(this._babylonScene.metadata):this._babylonScene.metadata.gltf&&(s.extras=this._babylonScene.metadata.gltf.extras)),(null===(r=this._options.removeNoopRootNodes)||void 0===r||r)&&!this._options.includeCoordinateSystemConversionNodes)for(var c=0,f=this._babylonScene.rootNodes;c<f.length;c++){var p=f[c];T(p,this._babylonScene.useRightHandedSystem)&&(l.add(p),u.splice(u.indexOf(p),1))}var _=new Map;this._babylonScene.cameras.forEach((function(e){if(!o._options.shouldExportNode||o._options.shouldExportNode(e)){var t={type:e.mode===d.Camera.PERSPECTIVE_CAMERA?"perspective":"orthographic"};if(e.name&&(t.name=e.name),"perspective"===t.type)t.perspective={aspectRatio:e.getEngine().getAspectRatio(e),yfov:e.fovMode===d.Camera.FOVMODE_VERTICAL_FIXED?e.fov:e.fov*e.getEngine().getAspectRatio(e),znear:e.minZ,zfar:e.maxZ};else if("orthographic"===t.type){var r=e.orthoLeft&&e.orthoRight?.5*(e.orthoRight-e.orthoLeft):.5*e.getEngine().getRenderWidth(),n=e.orthoBottom&&e.orthoTop?.5*(e.orthoTop-e.orthoBottom):.5*e.getEngine().getRenderHeight();t.orthographic={xmag:r,ymag:n,znear:e.minZ,zfar:e.maxZ}}_.set(e,o._cameras.length),o._cameras.push(t)}}));var m=(t=this._getExportNodes(u))[0],g=t[1];return this._glTFMaterialExporter._convertMaterialsToGLTFAsync(g,"image/png",!0).then((function(){return o._createNodeMapAndAnimationsAsync(m,e).then((function(t){return o._createSkinsAsync(t,e).then((function(r){if(o._nodeMap=t,o._totalByteLength=e.getByteOffset(),null==o._totalByteLength)throw new Error("undefined byte length!");for(var c=0,f=u;c<f.length;c++){var h=f[c];if(void 0!==(n=o._nodeMap[h.uniqueId])&&(i=o._nodes[n],h.metadata&&(o._options.metadataSelector?i.extras=o._options.metadataSelector(h.metadata):h.metadata.gltf&&(i.extras=h.metadata.gltf.extras)),h instanceof d.Camera&&(i.camera=_.get(h)),o._options.shouldExportNode&&!o._options.shouldExportNode(h)?d.Tools.Log("Omitting "+h.name+" from scene."):(h.parent||o._babylonScene.useRightHandedSystem||(T=i,v=void 0,b=void 0,A=void 0,v=d.Vector3.FromArrayToRef(T.translation||[0,0,0],0,d.TmpVectors.Vector3[0]),b=d.Quaternion.FromArrayToRef(T.rotation||[0,0,0,1],0,d.TmpVectors.Quaternion[0]),A=d.Vector3.FromArrayToRef(T.scale||[1,1,1],0,d.TmpVectors.Vector3[1]),d.Matrix.ComposeToRef(A,b,v,d.TmpVectors.Matrix[0]).multiplyToRef(x,d.TmpVectors.Matrix[0]).decompose(A,b,v),v.equalsToFloats(0,0,0)?delete T.translation:T.translation=v.asArray(),d.Quaternion.IsIdentity(b)?delete T.rotation:T.rotation=b.asArray(),A.equalsToFloats(1,1,1)?delete T.scale:T.scale=A.asArray()),h.parent&&!l.has(h.parent)||s.nodes.push(n)),h instanceof d.Mesh&&h.skeleton&&(i.skin=r[h.skeleton.uniqueId]),a=h.getDescendants(!0),!i.children&&a&&a.length)){for(var p=[],m=0,g=a;m<g.length;m++){var y=g[m];null!=o._nodeMap[y.uniqueId]&&p.push(o._nodeMap[y.uniqueId])}p.length&&(i.children=p)}}var T,v,b,A;s.nodes.length&&o._scenes.push(s)}))}))}))},e.prototype._getExportNodes=function(e){for(var t=[],r=new Set,n=0,i=e;n<i.length;n++){var a=i[n];if(!this._options.shouldExportNode||this._options.shouldExportNode(a)){t.push(a);var o=a;if(o.subMeshes&&o.subMeshes.length>0){var s=o.material||o.getScene().defaultMaterial;if(s instanceof d.MultiMaterial)for(var u=0,l=s.subMaterials;u<l.length;u++){var c=l[u];c&&r.add(c)}else r.add(s)}}else"Excluding node ".concat(a.name)}return[t,r]},e.prototype._createNodeMapAndAnimationsAsync=function(e,t){for(var r,n=this,i=Promise.resolve(),a={},o={name:"runtime animations",channels:[],samplers:[]},s=[],u=function(e){i=i.then((function(){return n._createNodeAsync(e,t).then((function(i){var u=n._extensionsPostExportNodeAsync("createNodeAsync",i,e,a,t);return null==u?(d.Tools.Warn("Not exporting node ".concat(e.name)),Promise.resolve()):u.then((function(i){i&&(n._nodes.push(i),r=n._nodes.length-1,a[e.uniqueId]=r,n._babylonScene.animationGroups.length||(g._CreateMorphTargetAnimationFromMorphTargetAnimations(e,o,s,a,n._nodes,t,n._bufferViews,n._accessors,n._animationSampleRate,n._options.shouldExportAnimation),e.animations.length&&g._CreateNodeAnimationFromNodeAnimations(e,o,s,a,n._nodes,t,n._bufferViews,n._accessors,n._animationSampleRate,n._options.shouldExportAnimation)))}))}))}))},l=0,c=e;l<c.length;l++)u(c[l]);return i.then((function(){return o.channels.length&&o.samplers.length&&n._animations.push(o),s.forEach((function(e){e.channels.length&&e.samplers.length&&n._animations.push(e)})),n._babylonScene.animationGroups.length&&g._CreateNodeAndMorphAnimationFromAnimationGroups(n._babylonScene,n._animations,a,t,n._bufferViews,n._accessors,n._animationSampleRate,n._options.shouldExportAnimation),a}))},e.prototype._createNodeAsync=function(e,t){var r=this;return Promise.resolve().then((function(){var n={},i={primitives:[]};if(e.name&&(n.name=e.name),e instanceof d.TransformNode){if(r._setNodeTransformation(n,e),e instanceof d.Mesh){var a=e.morphTargetManager;if(a&&a.numTargets>0){i.weights=[];for(var o=0;o<a.numTargets;++o)i.weights.push(a.getTarget(o).influence)}}return r._setPrimitiveAttributesAsync(i,e,t).then((function(){return i.primitives.length&&(r._meshes.push(i),n.mesh=r._meshes.length-1),n}))}return e instanceof d.Camera?(r._setCameraTransformation(n,e),n):n}))},e.prototype._createSkinsAsync=function(e,t){for(var r,n=Promise.resolve(),i={},a=0,o=this._babylonScene.skeletons;a<o.length;a++){var s=o[a];if(!(s.bones.length<=0)){for(var u={joints:[]},l=[],c={},f=-1,h=0;h<s.bones.length;++h)-1!==(p=null!==(r=(_=s.bones[h]).getIndex())&&void 0!==r?r:h)&&(c[p]=_,p>f&&(f=p));for(var p=0;p<=f;++p){var _=c[p];l.push(_.getInvertedAbsoluteTransform());var g=_.getTransformNode();g&&null!==e[g.uniqueId]&&void 0!==e[g.uniqueId]?u.joints.push(e[g.uniqueId]):d.Tools.Warn("Exporting a bone without a linked transform node is currently unsupported")}if(u.joints.length>0){var x=64*l.length,y=t.getByteOffset(),T=m._CreateBufferView(0,y,x,void 0,"InverseBindMatrices - "+s.name);this._bufferViews.push(T);var v=this._bufferViews.length-1,b=m._CreateAccessor(v,"InverseBindMatrices - "+s.name,"MAT4",5126,l.length,null,null,null),A=this._accessors.push(b)-1;u.inverseBindMatrices=A,this._skins.push(u),i[s.uniqueId]=this._skins.length-1,l.forEach((function(e){e.m.forEach((function(e){t.setFloat32(e)}))}))}}}return n.then((function(){return i}))},e._ExtensionNames=new Array,e._ExtensionFactories={},e}(),b=function(){function e(e){this._arrayBuffer=new ArrayBuffer(e),this._dataView=new DataView(this._arrayBuffer),this._byteOffset=0}return e.prototype._resizeBuffer=function(e){var t=new ArrayBuffer(e),r=Math.min(this._arrayBuffer.byteLength,e),n=new Uint8Array(this._arrayBuffer,0,r);return new Uint8Array(t).set(n,0),this._arrayBuffer=t,this._dataView=new DataView(this._arrayBuffer),t},e.prototype.getArrayBuffer=function(){return this._resizeBuffer(this.getByteOffset())},e.prototype.getByteOffset=function(){if(null==this._byteOffset)throw new Error("Byte offset is undefined!");return this._byteOffset},e.prototype.setUInt8=function(e,t){null!=t?t<this._byteOffset?this._dataView.setUint8(t,e):d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint8(this._byteOffset,e),this._byteOffset+=1)},e.prototype.setUInt16=function(e,t){null!=t?t<this._byteOffset?this._dataView.setUint16(t,e,!0):d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+2>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint16(this._byteOffset,e,!0),this._byteOffset+=2)},e.prototype.getUInt32=function(e){if(e<this._byteOffset)return this._dataView.getUint32(e,!0);throw d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"),new Error("BinaryWriter: byteoffset is greater than the current binary buffer length!")},e.prototype.getVector3Float32FromRef=function(e,t){t+8>this._byteOffset?d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0))},e.prototype.setVector3Float32FromRef=function(e,t){t+8>this._byteOffset?d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0))},e.prototype.getVector4Float32FromRef=function(e,t){t+12>this._byteOffset?d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(e.x=this._dataView.getFloat32(t,!0),e.y=this._dataView.getFloat32(t+4,!0),e.z=this._dataView.getFloat32(t+8,!0),e.w=this._dataView.getFloat32(t+12,!0))},e.prototype.setVector4Float32FromRef=function(e,t){t+12>this._byteOffset?d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._dataView.setFloat32(t,e.x,!0),this._dataView.setFloat32(t+4,e.y,!0),this._dataView.setFloat32(t+8,e.z,!0),this._dataView.setFloat32(t+12,e.w,!0))},e.prototype.setFloat32=function(e,t){isNaN(e)&&d.Tools.Error("Invalid data being written!"),null!=t&&(t<this._byteOffset?this._dataView.setFloat32(t,e,!0):d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary length!")),this._byteOffset+4>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setFloat32(this._byteOffset,e,!0),this._byteOffset+=4},e.prototype.setUInt32=function(e,t){null!=t?t<this._byteOffset?this._dataView.setUint32(t,e,!0):d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+4>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setUint32(this._byteOffset,e,!0),this._byteOffset+=4)},e.prototype.setInt16=function(e,t){null!=t?t<this._byteOffset?this._dataView.setInt16(t,e,!0):d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+2>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setInt16(this._byteOffset,e,!0),this._byteOffset+=2)},e.prototype.setByte=function(e,t){null!=t?t<this._byteOffset?this._dataView.setInt8(t,e):d.Tools.Error("BinaryWriter: byteoffset is greater than the current binary buffer length!"):(this._byteOffset+1>this._arrayBuffer.byteLength&&this._resizeBuffer(2*this._arrayBuffer.byteLength),this._dataView.setInt8(this._byteOffset,e),this._byteOffset++)},e}(),A=function(){function e(){}return e.GLTFAsync=function(e,t,r){return e.whenReadyAsync().then((function(){var n=t.replace(/\.[^/.]+$/,"");return new v(e,r)._generateGLTFAsync(n)}))},e._PreExportAsync=function(e,t){return Promise.resolve().then((function(){return t&&t.exportWithoutWaitingForScene?Promise.resolve():e.whenReadyAsync()}))},e._PostExportAsync=function(e,t,r){return Promise.resolve().then((function(){return r&&r.exportWithoutWaitingForScene,t}))},e.GLBAsync=function(e,t,r){var n=this;return this._PreExportAsync(e,r).then((function(){var i=t.replace(/\.[^/.]+$/,"");return new v(e,r)._generateGLBAsync(i).then((function(t){return n._PostExportAsync(e,t,r)}))}))},e}(),E="KHR_texture_transform",M=function(){function e(){this.name=E,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportTexture=function(e,t,r){if(r&&(0===r.uAng&&0===r.wAng&&0===r.vAng||0===r.uRotationCenter&&0===r.vRotationCenter)){var n={},i=!1;if(0===r.uOffset&&0===r.vOffset||(n.offset=[r.uOffset,r.vOffset],i=!0),1===r.uScale&&1===r.vScale||(n.scale=[r.uScale,r.vScale],i=!0),0!==r.wAng&&(n.rotation=-r.wAng,i=!0),0!==r.coordinatesIndex&&(n.texCoord=r.coordinatesIndex,i=!0),!i)return;this._wasUsed=!0,t.extensions||(t.extensions={}),t.extensions[E]=n}},e.prototype.preExportTextureAsync=function(e,t){return new Promise((function(r,n){t.getScene()?0!==t.uAng||0!==t.vAng?(d.Tools.Warn("".concat(e,": Texture ").concat(t.name," with rotation in the u or v axis is not supported in glTF.")),r(null)):0===t.wAng||0===t.uRotationCenter&&0===t.vRotationCenter?r(t):(d.Tools.Warn("".concat(e,": Texture ").concat(t.name," with rotation not centered at the origin cannot be exported with ").concat(E)),r(null)):n("".concat(e,': "scene" is not defined for Babylon texture ').concat(t.name,"!"))}))},e}();v.RegisterExtension(E,(function(){return new M}));var F="KHR_lights_punctual",w=function(){function e(e){this.name=F,this.enabled=!0,this.required=!1,this._exporter=e}return e.prototype.dispose=function(){this._lights=null},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return!!this._lights},enumerable:!1,configurable:!0}),e.prototype.onExporting=function(){this._exporter._glTF.extensions[F]=this._lights},e.prototype.postExportNodeAsync=function(e,t,r,n){var i=this;return new Promise((function(a){if(t&&r instanceof d.ShadowLight){var o=void 0,s=r.getTypeID()==d.Light.LIGHTTYPEID_POINTLIGHT?"point":r.getTypeID()==d.Light.LIGHTTYPEID_DIRECTIONALLIGHT?"directional":r.getTypeID()==d.Light.LIGHTTYPEID_SPOTLIGHT?"spot":null;if(null==s)d.Logger.Warn("".concat(e,": Light ").concat(r.name," is not supported in ").concat(F));else{if(r.position.equalsToFloats(0,0,0)||(t.translation=r.position.asArray()),"point"!==s){var u=r.direction,l=-Math.atan2(u.z,u.x)+Math.PI/2,c=Math.sqrt(u.x*u.x+u.z*u.z),f=-Math.atan2(u.y,c),h=d.Quaternion.RotationYawPitchRoll(l+Math.PI,f,0);d.Quaternion.IsIdentity(h)||(t.rotation=h.asArray())}if(r.falloffType!==d.Light.FALLOFF_GLTF&&d.Logger.Warn("".concat(e,": Light falloff for ").concat(r.name," does not match the ").concat(F," specification!")),o={type:s},r.diffuse.equals(d.Color3.White())||(o.color=r.diffuse.asArray()),1!==r.intensity&&(o.intensity=r.intensity),r.range!==Number.MAX_VALUE&&(o.range=r.range),"spot"===s){var p=r;p.angle!==Math.PI/2&&(null==o.spot&&(o.spot={}),o.spot.outerConeAngle=p.angle/2),0!==p.innerAngle&&(null==o.spot&&(o.spot={}),o.spot.innerConeAngle=p.innerAngle/2)}i._lights||(i._lights={lights:[]}),i._lights.lights.push(o);var _={light:i._lights.lights.length-1},m=r.parent;if(m&&1==m.getChildren().length){var g=i._exporter._nodes[n[m.uniqueId]];if(g){var x=d.Vector3.FromArrayToRef(g.translation||[0,0,0],0,d.TmpVectors.Vector3[0]),y=d.Quaternion.FromArrayToRef(g.rotation||[0,0,0,1],0,d.TmpVectors.Quaternion[0]),T=d.Vector3.FromArrayToRef(g.scale||[1,1,1],0,d.TmpVectors.Vector3[1]),v=d.Matrix.ComposeToRef(T,y,x,d.TmpVectors.Matrix[0]),b=d.Vector3.FromArrayToRef(t.translation||[0,0,0],0,d.TmpVectors.Vector3[2]),A=d.Quaternion.FromArrayToRef(t.rotation||[0,0,0,1],0,d.TmpVectors.Quaternion[1]),E=d.Matrix.ComposeToRef(d.Vector3.OneReadOnly,A,b,d.TmpVectors.Matrix[1]);return v.multiplyToRef(E,E),E.decompose(T,y,x),x.equalsToFloats(0,0,0)?delete g.translation:g.translation=x.asArray(),d.Quaternion.IsIdentity(y)?delete g.rotation:g.rotation=y.asArray(),T.equalsToFloats(1,1,1)?delete g.scale:g.scale=T.asArray(),g.extensions||(g.extensions={}),g.extensions[F]=_,void a(null)}}t.extensions||(t.extensions={}),t.extensions[F]=_}}a(t)}))},e}();v.RegisterExtension(F,(function(e){return new w(e)}));var C="KHR_materials_clearcoat",R=function(){function e(e){this.name=C,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRBaseMaterial&&r.clearCoat.isEnabled?(r.clearCoat.texture&&n.push(r.clearCoat.texture),!r.clearCoat.useRoughnessFromMainTexture&&r.clearCoat.textureRoughness&&n.push(r.clearCoat.textureRoughness),r.clearCoat.bumpTexture&&n.push(r.clearCoat.bumpTexture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRBaseMaterial){if(!r.clearCoat.isEnabled)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i,a=n._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.texture);i=r.clearCoat.useRoughnessFromMainTexture?n._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.texture):n._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.textureRoughness),r.clearCoat.isTintEnabled&&d.Tools.Warn("Clear Color tint is not supported for glTF export. Ignoring for: ".concat(r.name)),r.clearCoat.remapF0OnInterfaceChange&&d.Tools.Warn("Clear Color F0 remapping is not supported for glTF export. Ignoring for: ".concat(r.name));var o=n._exporter._glTFMaterialExporter._getTextureInfo(r.clearCoat.bumpTexture),s={clearcoatFactor:r.clearCoat.intensity,clearcoatTexture:null!=a?a:void 0,clearcoatRoughnessFactor:r.clearCoat.roughness,clearcoatRoughnessTexture:null!=i?i:void 0,clearcoatNormalTexture:null!=o?o:void 0,hasTextures:function(){return null!==s.clearcoatTexture||null!==s.clearcoatRoughnessTexture||null!==s.clearcoatRoughnessTexture}};t.extensions[C]=s}e(t)}))},e}();v.RegisterExtension(C,(function(e){return new R(e)}));var V="KHR_materials_iridescence",S=function(){function e(e){this.name=V,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRBaseMaterial&&r.iridescence.isEnabled?(r.iridescence.texture&&n.push(r.iridescence.texture),r.iridescence.thicknessTexture&&r.iridescence.thicknessTexture!==r.iridescence.texture&&n.push(r.iridescence.thicknessTexture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRBaseMaterial){if(!r.iridescence.isEnabled)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i=n._exporter._glTFMaterialExporter._getTextureInfo(r.iridescence.texture),a=n._exporter._glTFMaterialExporter._getTextureInfo(r.iridescence.thicknessTexture),o={iridescenceFactor:r.iridescence.intensity,iridescenceIor:r.iridescence.indexOfRefraction,iridescenceThicknessMinimum:r.iridescence.minimumThickness,iridescenceThicknessMaximum:r.iridescence.maximumThickness,iridescenceTexture:null!=i?i:void 0,iridescenceThicknessTexture:null!=a?a:void 0,hasTextures:function(){return null!==o.iridescenceTexture||null!==o.iridescenceThicknessTexture}};t.extensions[V]=o}e(t)}))},e}();v.RegisterExtension(V,(function(e){return new S(e)}));var I="KHR_materials_anisotropy",B=function(){function e(e){this.name=I,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRBaseMaterial&&r.anisotropy.isEnabled&&!r.anisotropy.legacy?(r.anisotropy.texture&&n.push(r.anisotropy.texture),n):[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRBaseMaterial){if(!r.anisotropy.isEnabled||r.anisotropy.legacy)return void e(t);n._wasUsed=!0,t.extensions=t.extensions||{};var i=n._exporter._glTFMaterialExporter._getTextureInfo(r.anisotropy.texture),a={anisotropyStrength:r.anisotropy.intensity,anisotropyRotation:r.anisotropy.angle,anisotropyTexture:null!=i?i:void 0,hasTextures:function(){return null!==a.anisotropyTexture}};t.extensions[I]=a}e(t)}))},e}();v.RegisterExtension(I,(function(e){return new B(e)}));var P="KHR_materials_sheen",N=function(){function e(e){this.name=P,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){return r instanceof d.PBRMaterial&&r.sheen.isEnabled&&r.sheen.texture?[r.sheen.texture]:[]},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i,a,o,s;if(r instanceof d.PBRMaterial){if(!r.sheen.isEnabled)return void e(t);n._wasUsed=!0,null==t.extensions&&(t.extensions={});var u={sheenColorFactor:r.sheen.color.asArray(),sheenRoughnessFactor:null!==(i=r.sheen.roughness)&&void 0!==i?i:0,hasTextures:function(){return null!==u.sheenColorTexture||null!==u.sheenRoughnessTexture}};r.sheen.texture&&(u.sheenColorTexture=null!==(a=n._exporter._glTFMaterialExporter._getTextureInfo(r.sheen.texture))&&void 0!==a?a:void 0),r.sheen.textureRoughness&&!r.sheen.useRoughnessFromMainTexture?u.sheenRoughnessTexture=null!==(o=n._exporter._glTFMaterialExporter._getTextureInfo(r.sheen.textureRoughness))&&void 0!==o?o:void 0:r.sheen.texture&&r.sheen.useRoughnessFromMainTexture&&(u.sheenRoughnessTexture=null!==(s=n._exporter._glTFMaterialExporter._getTextureInfo(r.sheen.texture))&&void 0!==s?s:void 0),t.extensions[P]=u}e(t)}))},e}();v.RegisterExtension(P,(function(e){return new N(e)}));var O="KHR_materials_unlit",L=function(){function e(){this.name=O,this.enabled=!0,this.required=!1,this._wasUsed=!1}return Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.dispose=function(){},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i=!1;r instanceof d.PBRMaterial?i=r.unlit:r instanceof d.StandardMaterial&&(i=r.disableLighting),i&&(n._wasUsed=!0,null==t.extensions&&(t.extensions={}),t.extensions[O]={}),e(t)}))},e}();v.RegisterExtension(O,(function(){return new L}));var U="KHR_materials_ior",k=function(){function e(){this.name=U,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){return!e.unlit&&null!=e.indexOfRefraction&&1.5!=e.indexOfRefraction},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var i={ior:r.indexOfRefraction};t.extensions=t.extensions||{},t.extensions[U]=i}e(t)}))},e}();v.RegisterExtension(U,(function(e){return new k}));var K="KHR_materials_specular",D=function(){function e(e){this.name=K,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.metallicReflectanceTexture&&n.push(r.metallicReflectanceTexture),r.reflectanceTexture&&n.push(r.reflectanceTexture),n):n},e.prototype._isExtensionEnabled=function(e){return!e.unlit&&(null!=e.metallicF0Factor&&1!=e.metallicF0Factor||null!=e.metallicReflectanceColor&&!e.metallicReflectanceColor.equalsFloats(1,1,1)||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.metallicReflectanceTexture||null!=e.reflectanceTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i,a;if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0,t.extensions=t.extensions||{};var o=null!==(i=n._exporter._glTFMaterialExporter._getTextureInfo(r.metallicReflectanceTexture))&&void 0!==i?i:void 0,s=null!==(a=n._exporter._glTFMaterialExporter._getTextureInfo(r.reflectanceTexture))&&void 0!==a?a:void 0,u={specularFactor:1==r.metallicF0Factor?void 0:r.metallicF0Factor,specularTexture:o,specularColorFactor:r.metallicReflectanceColor.equalsFloats(1,1,1)?void 0:r.metallicReflectanceColor.asArray(),specularColorTexture:s,hasTextures:function(){return n._hasTexturesExtension(r)}};t.extensions[K]=u}e(t)}))},e}();v.RegisterExtension(K,(function(e){return new D(e)}));var G="KHR_materials_volume",W=function(){function e(e){this.name=G,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isTranslucencyEnabled)&&(null!=t.maximumThickness&&0!=t.maximumThickness||null!=t.tintColorAtDistance&&t.tintColorAtDistance!=Number.POSITIVE_INFINITY||null!=t.tintColor&&t.tintColor!=d.Color3.White()||this._hasTexturesExtension(e))},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.thicknessTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i;if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var a=r.subSurface,o={thicknessFactor:0==a.maximumThickness?void 0:a.maximumThickness,thicknessTexture:null!==(i=n._exporter._glTFMaterialExporter._getTextureInfo(a.thicknessTexture))&&void 0!==i?i:void 0,attenuationDistance:a.tintColorAtDistance==Number.POSITIVE_INFINITY?void 0:a.tintColorAtDistance,attenuationColor:a.tintColor.equalsFloats(1,1,1)?void 0:a.tintColor.asArray(),hasTextures:function(){return n._hasTexturesExtension(r)}};t.extensions=t.extensions||{},t.extensions[G]=o}e(t)}))},e}();v.RegisterExtension(G,(function(e){return new W(e)}));var z="KHR_materials_dispersion",q=function(){function e(){this.name=z,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!(!t.isRefractionEnabled&&!t.isDispersionEnabled)},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var i={dispersion:r.subSurface.dispersion};t.extensions=t.extensions||{},t.extensions[z]=i}e(t)}))},e}();v.RegisterExtension(z,(function(){return new q}));var H="KHR_materials_transmission",j=function(){function e(e){this.name=H,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return t.isRefractionEnabled&&null!=t.refractionIntensity&&0!=t.refractionIntensity||this._hasTexturesExtension(e)},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.refractionIntensityTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i;if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var a=r.subSurface,o={transmissionFactor:0===a.refractionIntensity?void 0:a.refractionIntensity,transmissionTexture:null!==(i=n._exporter._glTFMaterialExporter._getTextureInfo(a.refractionIntensityTexture))&&void 0!==i?i:void 0,hasTextures:function(){return n._hasTexturesExtension(r)}};t.extensions=t.extensions||{},t.extensions[H]=o}e(t)}))},e}();v.RegisterExtension(H,(function(e){return new j(e)}));var Q="EXT_mesh_gpu_instancing",Y=function(){function e(e){this.name=Q,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportNodeAsync=function(e,t,r,n,i){var a=this;return new Promise((function(e){if(t&&r instanceof d.Mesh&&r.hasThinInstances&&i){a._wasUsed=!0;for(var n=d.Vector3.Zero(),o=d.Quaternion.Identity(),s=d.Vector3.One(),u=r.thinInstanceGetWorldMatrices(),l=d.TmpVectors.Vector3[2],c=d.TmpVectors.Quaternion[1],f=d.TmpVectors.Vector3[3],h=!1,p=!1,_=!1,m=new Float32Array(3*r.thinInstanceCount),g=new Float32Array(4*r.thinInstanceCount),x=new Float32Array(3*r.thinInstanceCount),y=0,T=0,v=u;T<v.length;T++)v[T].decompose(f,c,l),m.set(l.asArray(),3*y),g.set(c.normalize().asArray(),4*y),x.set(f.asArray(),3*y),h=h||!l.equalsWithEpsilon(n),p=p||!c.equalsWithEpsilon(o),_=_||!f.equalsWithEpsilon(s),y++;var b={attributes:{}};h&&(b.attributes.TRANSLATION=a._buildAccessor(m,"VEC3",r.thinInstanceCount,i,5126)),p&&(b.attributes.ROTATION=a._buildAccessor(g,"VEC4",r.thinInstanceCount,i,5126)),_&&(b.attributes.SCALE=a._buildAccessor(x,"VEC3",r.thinInstanceCount,i,5126)),t.extensions=t.extensions||{},t.extensions[Q]=b}e(t)}))},e.prototype._buildAccessor=function(e,t,r,n,i){var a=n.getByteOffset();switch(i){case 5126:for(var o=0;o!=e.length;o++)n.setFloat32(e[o]);break;case 5120:for(o=0;o!=e.length;o++)n.setByte(127*e[o]);break;case 5122:for(o=0;o!=e.length;o++)n.setInt16(32767*e[o])}var s={buffer:0,byteOffset:a,byteLength:e.length*d.VertexBuffer.GetTypeByteLength(i)},u=this._exporter._bufferViews.length;this._exporter._bufferViews.push(s);var l=this._exporter._accessors.length,c={bufferView:u,componentType:i,count:r,type:t,normalized:5120==i||5122==i};return this._exporter._accessors.push(c),l},e}();v.RegisterExtension(Q,(function(e){return new Y(e)}));var X="KHR_materials_emissive_strength",Z=function(){function e(){this.name=X,this.enabled=!0,this.required=!1,this._wasUsed=!1}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){if(!(r instanceof d.PBRMaterial))return e(t);var i=r.emissiveColor.asArray(),a=Math.max.apply(Math,i);if(a>1){n._wasUsed=!0,t.extensions||(t.extensions={});var o={emissiveStrength:a},s=r.emissiveColor.scale(1/o.emissiveStrength);t.emissiveFactor=s.asArray(),t.extensions[X]=o}return e(t)}))},e}();v.RegisterExtension(X,(function(e){return new Z}));var J="KHR_materials_diffuse_transmission",$=function(){function e(e){this.name=J,this.enabled=!0,this.required=!1,this._wasUsed=!1,this._exporter=e}return e.prototype.dispose=function(){},Object.defineProperty(e.prototype,"wasUsed",{get:function(){return this._wasUsed},enumerable:!1,configurable:!0}),e.prototype.postExportMaterialAdditionalTextures=function(e,t,r){var n=[];return r instanceof d.PBRMaterial&&this._isExtensionEnabled(r)?(r.subSurface.thicknessTexture&&n.push(r.subSurface.thicknessTexture),n):n},e.prototype._isExtensionEnabled=function(e){if(e.unlit)return!1;var t=e.subSurface;return!!t.isTranslucencyEnabled&&!e.unlit&&!t.useAlbedoToTintTranslucency&&t.useGltfStyleTextures&&1===t.volumeIndexOfRefraction&&0===t.minimumThickness&&0===t.maximumThickness},e.prototype._hasTexturesExtension=function(e){return null!=e.subSurface.translucencyIntensityTexture||null!=e.subSurface.translucencyColorTexture},e.prototype.postExportMaterialAsync=function(e,t,r){var n=this;return new Promise((function(e){var i,a;if(r instanceof d.PBRMaterial&&n._isExtensionEnabled(r)){n._wasUsed=!0;var o=r.subSurface,s={diffuseTransmissionFactor:1==o.translucencyIntensity?void 0:o.translucencyIntensity,diffuseTransmissionTexture:null!==(i=n._exporter._glTFMaterialExporter._getTextureInfo(o.translucencyIntensityTexture))&&void 0!==i?i:void 0,diffuseTransmissionColorFactor:!o.translucencyColor||o.translucencyColor.equalsFloats(1,1,1)?void 0:o.translucencyColor.asArray(),diffuseTransmissionColorTexture:null!==(a=n._exporter._glTFMaterialExporter._getTextureInfo(o.translucencyColorTexture))&&void 0!==a?a:void 0,hasTextures:function(){return n._hasTexturesExtension(r)}};t.extensions=t.extensions||{},t.extensions[J]=s}e(t)}))},e}();v.RegisterExtension(J,(function(e){return new $(e)}));var ee=0,te=void 0!==n.g?n.g:"undefined"!=typeof window?window:void 0;if(void 0!==te){te.BABYLON=te.BABYLON||{};var re=te.BABYLON;re.GLTF2=re.GLTF2||{},re.GLTF2.Exporter=re.GLTF2.Exporter||{},re.GLTF2.Exporter.Extensions=re.GLTF2.Exporter.Extensions||{};var ne=[];for(var ie in e)re[ie]=e[ie],ne.push(ie);for(var ie in t)re[ie]=t[ie],ne.push(ie);for(var ie in r)re[ie]=r[ie],ne.push(ie);for(var ie in a)re.GLTF2.Exporter.Extensions[ie]=a[ie],ne.push(ie);for(var ie in o)ne.indexOf(ie)>-1||(re.GLTF2.Exporter[ie]=o[ie])}const ae=s})(),i.default})()));
//# sourceMappingURL=babylon.glTF2Serializer.min.js.map